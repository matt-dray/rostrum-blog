---
title: "Knit with params"
author: Matt Dray
date: '2020-03-03'
slug: knit-with-params
categories:
  - code
  - tutorial
tags:
  - knitr
  - automation
  - purrr
  - r
  - reproducibility
  - rmarkdown
draft: yes
---



<div id="tldr" class="section level1">
<h1>tl;dr</h1>
<p>You want to generate multiple reports from a single template, supplying different data for each one.</p>
<p>You can use the <code>map()</code> function from the {purrr} package to iterate over parameters (‘params’) supplied to {knitr}’s <code>render()</code> function. This will produce a separate output for each param supplied.</p>
</div>
<div id="rmarkdown" class="section level1">
<h1>RMarkdown</h1>
<p>RMarkdown lets you integrate code into a document, which is great for creating reproducible reports. Your data changed? No problem, just re-render it with the new data.</p>
<p>What if you actually need to produce multiple reports: one for each <em>x</em>, where <em>x</em> could be a department, a country, or you know, a Pokémon species.</p>
<p>Sure, we could open the template, change the input and re-render it over and over. Or we could produce hundreds of reports wth a single command by using ‘params’.</p>
</div>
<div id="yaml" class="section level1">
<h1>YAML</h1>
<p>If you’ve used RMarkdown before, you’ll be familiar with YAML. This is the header of your document to which you supply meta-information about your document. For example:</p>
<pre><code>title: Demo 
author: Matt Dray
date: 2020-03-04</code></pre>
<p>Turns out you can also add a ‘params’ argument to the YAML. What for? You can use it to specify a variable, like a year or location, and then wherever that parameter is referenced in the document it will take the parameter that you supplied.</p>
<p>So maybe your YAML declares a param like this:</p>
<pre><code>params:
  dinosaur: &quot;triceratops&quot;</code></pre>
<p>And then in your RMarkdown document you can refer to that parameter inline like:</p>
<pre class="r"><code>This article is about `r params$dinosaur`. </code></pre>
<p>Or you can use it inside an RMarkdown chunk:</p>
<pre class="r"><code>filter(data, species = params$dinosaur)</code></pre>
<p>This is good because it means you only declare the variable once. No more copy-pasting ‘2020’ into every spot where you mention the year.</p>
</div>
<div id="change-the-param" class="section level1">
<h1>Change the param</h1>
<p>You could open up the template and change the param value for each report, but that’s error-prine and wastes time.</p>
<p>Actually, the param value you provided in the YAML is just a default. Instead, you can supply a different value from {knitr}’s render function:</p>
<pre class="r"><code>render(
  input = &quot;your-report.Rmd&quot;,
  params = list(dinosaur = &quot;iguanadon&quot;),
)</code></pre>
<p>This will replace the default with the vaue provided in the <code>params</code> argumnt. You can have multiple params, so you can provide them one by one in a <code>list()</code> to the <code>params</code> argument.</p>
<p>Executing this function will cause the output to be rendered using the provided param value rather than the default one. You didn’t need to edit the RMarkdown file at all.</p>
</div>
<div id="looping" class="section level1">
<h1>Looping</h1>
<p>That’s fine, but what if you have lots more elements to iterate over?</p>
<p>You can use the power of the <code>map()</code> function from {purrr} to iterate over multiple values for your param, generating a separate report for each one. You could have a script file with the following content</p>
<pre class="r"><code># Create a vector of the elements to iterate over
dinos &lt;- c(&quot;triceratops&quot;, &quot;iguanadon&quot;, &quot;allosaurus&quot;)

# To each element of the vector, render the template
# with the vector element as the element
map(
  .x = dinos,
  .f = ~render(
    input = &quot;dino-report-template.Rmd&quot;,  # RMarkdown filepath
    params = list(dinosaur = .x),  # parameter value
    output_file = paste0(&quot;report&quot;, .x, &quot;.html&quot;)  # rendered output path
    )
  )
)</code></pre>
<p>Let’s talk this through.</p>
<p>The <code>map()</code> function from {purrr} can loop a function (<code>.f</code>) over elements of a vector or list (<code>.x</code>). This produces one output per element of <code>.x</code>.</p>
<p>How do the elements of our vector get passed as params? Inside the <code>render()</code> function we’ve specified that the <code>params</code> argument should take the values from <code>.x</code>. Each time we loop over the vector with <code>map()</code>, a different vector element will be passed to the ‘dinosaur’ param in the RMarkdown temaplate. For good measure, I’ve added <code>.x</code> to the <code>output_file</code> argument to make sure we get a unique filename for our output that contains the vector element.</p>
</div>
