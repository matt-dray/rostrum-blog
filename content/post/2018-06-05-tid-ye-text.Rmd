---
title: Tid-ye-text
author: Matt Dray
date: '2018-06-05'
slug: tid-ye-text
categories:
  - pop culture
  - R
  - text analysis
tags:
  - geniusr
  - dplyr
  - ggplot2
  - kanye
  - music
  - tidytext
  - datatable
  - purrr
draft: TRUE
---

<span style="color:lightgray">Matt Dray</span>

Warning: this post contains offensive content.

***

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warnings = FALSE, message = FALSE, error = FALSE, eval = TRUE)
```

<img src="https://media.giphy.com/media/9cmVjltMzhPUY/giphy.gif" alt="An animated gif of Kanye saying that he's a genius">

# Genius?

Kanye West released his latest album -- [*ye*](https://en.wikipedia.org/wiki/Ye_(album)) -- last week[^1] after a(nother) pretty turbulent period of his life[^2]. So what's been on his mind?

I think the real question is *what better time to learn about scraping lyrics and analysing them using R*, am I right?[^3]

# Genius

[Genius](https://genius.com/) is a website where you can upload and comment on song lyrics. It's like [Pop Up Video](https://www.youtube.com/watch?v=vam8l-JtqcI) for young people.

You can access the lyrics data via an API[^4] using [R](https://www.r-project.org/about.html) with the [`genuisr`](https://github.com/ewenme/geniusr) package by Ewen Henderson ([web](https://ewen.io/), [Github](https://github.com/ewenme), [Twitter](https://twitter.com/ewen_)).[^5] 

# Set up a Genius app 

Before using `geniusr` you need to register an 'app', which will provide you with tokens that allow you to access the service. To do this:

1. [Create a new Genius API client](https://genius.com/api-clients/new).
2. Click 'generate access token' under 'client access token' to generate an access token.
3. After `install.packages("geniusr"); library(geniusr); geniusr::genius_token()` you'll be prompted to enter the access token 

I stored my access token in my .Renviron file. This plain-text file provides a place to store variables that R will look for and load automatically. Edit this file by running `usethis::edit_r_environ()` and adding the line `GENIUS_API_TOKEN=X`, replacing X with your token.

# R

## Packages

Let's start by loading the packages we'll need.

```{r packages}
# get and analyse lyrics
library(geniusr)  # access lyrics
library(tidytext)  # wrangle text

# data manipulation
library(dplyr)  # manipulate date
library(tidyr)  # work with tidy data
library(purrr)  # functional programming

# presentation
library(ggplot2)  # plots
library(DT)  # interactive tables
```

## Find Kanye

First we need to find the artist ID for Kanye. We can use `search_artist()` to look for him.

```{r get_artist_id}
geniusr::search_artist("kanye west") %>% 
  knitr::kable()
```

Kanye's ID on Genius is 72 as a solo artist. We can save this value as the object `kanye_id` and use it to get metadata about him. This includes the web address for his artist page on Genius, a link to the image of him used on the site and the number of people 'following' his lyrics page.

```{r get_artist_meta}
# artist ID
kanye_id <- 72

# access meta info
artist_meta <- geniusr::get_artist_meta(
  artist_id = kanye_id
)

# preview
dplyr::glimpse(artist_meta)
```

## Get songs

Now we can use Kanye's artist ID to obtain *all* his songs on Genius.

```{r get_songs}
# get all songs for a given artist id
kanye_songs <- geniusr::get_artist_songs(
  artist_id = kanye_id
)

# a random preview
dplyr::sample_n(kanye_songs, 10) %>%
  select(song_name) %>% 
  knitr::kable()
```

We can also access a greater list of data for each song, including the album name and release date.

```{r get_song_meta}
# apply function over each song id
songs_meta <- purrr::map_df(
  kanye_songs$song_id,
  geniusr::get_song_meta
)

# a random preview
dplyr::sample_n(songs_meta, 10) %>% 
  dplyr::select(song_name, album_name) %>% 
  knitr::kable()
```

Looking at the album names, it seems we've got songs from 37 albums at least plus a bunch that are unknown or unclassified.

```{r unique_albums}
# the songs are from which albums?
unique(songs_meta$album_name)
```

So you can see *ye* is definitely in the list of albums and we can filter our data frame so we just get the seven tracks from that particular album. Maybe we'll explore the other lyrics more deeply another day.

```{r just_ye_album}
# filter songs from album 'ye'
ye <- songs_meta %>% 
  dplyr::filter(album_name == "ye")

# preview songs
dplyr::select(ye, song_name)
```

We can fecth the lyrics from Genius for each song now that we have their details. We can do this using `map_df()` from the `purrr` package to apply the `scrape_lyrics_url()` function to each row of our dataframe, where each row represents a single song.

```{r ye_get_lyrics}
# get lyrics
ye_lyrics <- purrr::map_df(
  ye$song_lyrics_url,
  geniusr::scrape_lyrics_url
)

# join additional information
ye_lyrics <- ye_lyrics %>%
  group_by(song_name) %>% 
  mutate(line_number = row_number()) %>% 
  ungroup() %>% 
  left_join(ye, by = "song_name")

# check out a sample of lines
ye_lyrics %>% 
  dplyr::sample_n(10) %>% 
  select(line, song_name)
```

# Text analysis

## Extract words

Now we've got the lines separated, we can bring in [the `tidytext` package from Julia Silge and David Robinson](https://www.tidytextmining.com/index.html) to break the lines into 'tokens' for further text analysis. Tokens are individual units of text prepared for analysis. In our case, we're looking at individual words, or 'unigrams'.

We should probabaly remove stop words. These are words don't really have much meaning in this context because of their ubiquity, like 'if', 'and' and 'but'. We can get rid of these by anti-joining a pre-prepared list of such words.

```{r word_per_row}
ye_words <- ye_lyrics %>%
  tidytext::unnest_tokens(word, line) %>%  # separate the tokens out
  dplyr::anti_join(tidytext::stop_words)  # remove words like 'if', 'and', 'but'

dplyr::sample_n(ye_words, 10) %>% 
  dplyr::select(word, song_name) %>% 
  knitr::kable()
```

Note that this isn't *completely* successful. Kanye also uses colloquialisms and words like 'ima'; a contraction of two stop words that isn't represented in our stop-word dictionary.

## Word frequency

### Words

```{r count_words_table}
ye_words %>%
  dplyr::mutate(word = as.factor(word)) %>% 
  dplyr::count(word, sort = TRUE) %>% 
  DT::datatable(
    filter = "top",
    options = list(
      autoWidth = TRUE,
      pageLength = 10
    )
  )
```

And as a plot.

```{r plot_word_freq}
ye_words %>%
  dplyr::count(word, sort = TRUE) %>%
  dplyr::filter(n > 5) %>%
  dplyr::mutate(word = reorder(word, n)) %>%
  ggplot2::ggplot(aes(word, n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip() +
  theme_minimal()
```

### Bigrams

```{r count_bigrams_table}
ye_bigrams <- ye_lyrics %>%
  tidytext::unnest_tokens(
    bigram,
    line,
    token = "ngrams",
    n = 2
  )

ye_bigrams_separated <- ye_bigrams %>%
  tidyr::separate(
    bigram,
    c("word1", "word2"),
    sep = " "
  )

ye_bigrams_filtered <- ye_bigrams_separated %>%
  dplyr::filter(
    !word1 %in% tidytext::stop_words$word,
    !word2 %in% tidytext::stop_words$word
  ) %>%
  dplyr::mutate(bigram = paste(word1, word2))

sample_n(ye_bigrams_filtered, 10) %>% 
  dplyr::select(bigram, song_name)
```

```{r}
ye_bigrams_filtered %>%
  dplyr::mutate(bigram = as.factor(bigram)) %>% 
  dplyr::count(bigram, sort = TRUE) %>% 
  DT::datatable(
    options = list(
      autoWidth = TRUE,
      pageLength = 10
    )
  )
```

```{r}
ye_bigrams_filtered %>%
  dplyr::count(bigram, sort = TRUE) %>%
  dplyr::filter(n > 3) %>%
  dplyr::mutate(bigram = reorder(bigram, n)) %>%
  ggplot2::ggplot(aes(bigram, n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip() +
  theme_minimal()
```


[^1]: This is not a review of the album. [There's plenty of those already](http://www.metacritic.com/music/ye/kanye-west).
[^2]: This is also not a commentary on [his *many* controversies](https://en.wikipedia.org/wiki/Kanye_West#Controversies).
[^3]: I am right.
[^4]: An ['Application Programme Interface'](https://medium.freecodecamp.org/what-is-an-api-in-english-please-b880a3214a82), which is a fancy way of saying 'computers talking to computers'.
[^5]: Note that there's also a `geniusR` package, which has a very similar name, but has to be [installed from GitHub](https://github.com/JosiahParry/geniusR) rather than CRAN.