---
title: 'Can {drake} RAP?'
author: Matt Dray
date: '2019-06-10'
slug: drake-lays-an-egg
categories:
  - R
tags:
  - reproducibility
  - drake
  - eggs
  - rap
  - reproducible analytical pipelines
  - make
  - make file
draft: yes
---

# Take the RAP

[Reproducible Analytical Pipelines](https://ukgovdatascience.github.io/rap-website/) (RAP) is an approach to generating [the UK government's official statistics](https://www.gov.uk/search/research-and-statistics) that improves reproducibility, minimises errors and speeds up production.

RAP does away with the tangled webs of spreadsheets, copy-pasting errors and infernal `publication_FINAL-v2_md-comments_FINAL.docx` file naming.

Instead, RAP encourages a script-based workflow that's beefed up with stuff like version control, dependency management and automated testing.

# Make it

Projects can become complicated with multiple inputs, script files and outputs.

Sometimes you need to re-run your code if you've made a change. With a makefile, you only run the parts that have changed plus anything downstream that depends on those parts.

You can get around this with a ['makefile'](https://en.wikipedia.org/wiki/Makefile). In short, you record each step of your analysis in a 'recipe' and the dependencies between each step are recorded.

Now you don't have to re-run the entire analysis if a change is made. Only the things that need to be re-run will be re-run. This saves compute time and means you don't have to remember any dependencies yourself.

# Bake a {drake} make cake

[{drake}](https://github.com/ropensci/drake) is a package by [Will Landau](https://wlandau.github.io/) that lets you create makefiles using R syntax. Drake == Dataframes in R for Make.

In brief, you prepare a 'plan' file that records all the functions to be run. Running the plan for the first time will run all the steps of the analysis. Nothing will happen if you try to run it a second time because everything is up to date. If you make a small change to your code and then re-run the plan, then only the parts of the code impacted by that change are re-run.

{drake} provides a helpful dependency network diagram so you can understand these relationships and what has changed following any modifications of the code.

There's some helpful material out there for learning more about {drake}:

* [User Manual](https://ropenscilabs.github.io/drake-manual/)
* [Documentation](https://ropensci.github.io/drake/)
* [Cheat sheet](https://github.com/krlmlr/drake-sib-zurich/blob/master/cheat-sheet.pdf) by Kirill MÃ¼ller
* [Drake for workflow happiness](https://aedobbyn.github.io/nyc-fires/index.html#1) slides by [Amanda Dobbyn](https://dobb.ae/)

# {drake} it to make it

I've made a very simple {drake} demo for an imaginary RAP project.

* [GitHub](https://github.com/matt-dray/drake-egg-rap)
* [Example HTML output](https://matt-dray.github.io/drake-egg-rap/)

## Eggsample

There is a [statistical publication that tracks UK egg production](https://www.gov.uk/government/statistics/egg-statistics). As far as I know, it's not currently created using a RAP process. It's a prime candidate though:

* the content has remained pretty consistent over time, so little manual change would be required to the report template
* it's produced quarterly, so total time savings could be high 
* it's badged as [National Statistics](https://www.statisticsauthority.gov.uk/osr/list-of-national-statistics/) and must therefore uphold certain quality standards
* there was an error in calculating year-on-year change in May this year (click '+ show all updates' on [the egg statistics page](https://www.gov.uk/government/statistics/egg-statistics), which is exactly the type of thing that RAP is designed to help reduce

Here I'll show how to recreate a small part of the publication using {drake}.

## Folder structure

## A very cunning plan

[^natstats]: In the UK, National Statistics are a special form of statistical publication that are considered to be of importance and have met certain standards.