---
title: "Knit with params"
author: Matt Dray
date: '2020-03-03'
slug: knit-with-params
categories:
  - code
  - tutorial
tags:
  - knitr
  - automation
  - purrr
  - r
  - reproducibility
  - rmarkdown
draft: yes
---

# tl;dr

You want to generate multiple reports from a single template, supplying different data for each one.

You can use the `map()` function from the {purrr} package to iterate over parameters ('params') supplied to {knitr}'s `render()` function. This will produce a separate output for each param supplied.

# RMarkdown

RMarkdown lets you integrate code into a document, which is great for creating reproducible reports. Your data changed? No problem, just re-render it with the new data.

What if you actually need to produce multiple reports: one for each _x_, where _x_ could be a department, a country, or you know, a Pok√©mon species.

Sure, we could open the template, change the input and re-render it over and over. Or we could produce hundreds of reports wth a single command by using 'params'.

# YAML

If you've used RMarkdown before, you'll be familiar with YAML. This is the header of your document to which you supply meta-information about your document. For example:

```
title: Demo 
author: Matt Dray
date: 2020-03-04
```

Turns out you can also add a 'params' argument to the YAML. What for? You can use it to specify a variable, like a year or location, and then wherever that parameter is referenced in the document it will take the parameter that you supplied.

So maybe your YAML declares a param like this:

```
params:
  dinosaur: "triceratops"
```

And then in your RMarkdown document you can refer to that parameter inline like:

```{r eval=FALSE}
This article is about `r params$dinosaur`. 
```

Or you can use it inside an RMarkdown chunk:

```{r eval=FALSE}
filter(data, species = params$dinosaur)
```

This is good because it means you only declare the variable once. No more copy-pasting '2020' into every spot where you mention the year.


# Change the param

You could open up the template and change the param value for each report, but that's error-prine and wastes time.

Actually, the param value you provided in the YAML is just a default. Instead, you can supply a different value from {knitr}'s render function:

```{r eval=FALSE}
render(
  input = "your-report.Rmd",
  params = list(dinosaur = "iguanadon"),
)
```

This will replace the default with the vaue provided in the `params` argumnt. You can have multiple params, so you can provide them one by one in a `list()` to the `params` argument.

Executing this function will cause the output to be rendered using the provided param value rather than the default one. You didn't need to edit the RMarkdown file at all.

# Looping

That's fine, but what if you have lots more elements to iterate over?

You can use the power of the `map()` function from {purrr} to iterate over multiple values for your param, generating a separate report for each one. You could have a script file with the following content

```{r eval=FALSE}
# Create a vector of the elements to iterate over
dinos <- c("triceratops", "iguanadon", "allosaurus")

# To each element of the vector, render the template
# with the vector element as the element
map(
  .x = dinos,
  .f = ~render(
    input = "dino-report-template.Rmd",  # RMarkdown filepath
    params = list(dinosaur = .x),  # parameter value
    output_file = paste0("report", .x, ".html")  # rendered output path
    )
  )
)
```

Let's talk this through.

The `map()` function from {purrr} can loop a function (`.f`) over elements of a vector or list (`.x`). This produces one output per element of `.x`.

How do the elements of our vector get passed as params? Inside the `render()` function we've specified that the `params` argument should take the values from `.x`. Each time we loop over the vector with `map()`, a different vector element will be passed to the 'dinosaur' param in the RMarkdown temaplate. For good measure, I've added `.x` to the `output_file` argument to make sure we get a unique filename for our output that contains the vector element.



