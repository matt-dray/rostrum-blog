---
title: 'Can {drake} RAP?'
author: Matt Dray
date: '2019-06-10'
slug: drake-lays-an-egg
categories:
  - R
tags:
  - reproducibility
  - drake
  - eggs
  - rap
  - reproducible analytical pipelines
  - make
  - make file
draft: yes
---



<div id="tldr" class="section level1">
<h1>tl;dr</h1>
<p>The <a href="https://github.com/ropensci/drake">{drake}</a> package records file interdependecies in your analysis. When files are changed, {drake} only re-runs the parts of your analysis that need to be re-run.</p>
</div>
<div id="make-it-to-make-it" class="section level1">
<h1>Make it to make it</h1>
<p>Analysis projects can become complicated as multiple inputs, script files and outputs build up.</p>
<p>You’ll need to re-run your code if any file edits are made. Can you remember exactly which scripts need to be re-executed? Or will you have to re-run the entire project from scratch? This is especially tedious in a large project.</p>
<p>A <a href="https://en.wikipedia.org/wiki/Makefile">‘makefile’</a> can help you. In short, it’s a text file in which you write each step of your analysis in a recipe-like format. Dependencies between data, code and outputs are recorded.</p>
<p>Now when something changes, only the affected file and those downstream from it will be re-executed. This saves compute time and means you don’t have to remember any dependencies yourself.</p>
</div>
<div id="drake-it-to-make-it" class="section level1">
<h1>{drake} it to make it</h1>
<p><a href="https://github.com/ropensci/drake">{drake}</a> is a package by <a href="https://wlandau.github.io/">Will Landau</a> that gives you makefiles with R syntax. The project is part of <a href="https://ropensci.org/">rOpenSci</a>, which seeks to make tools for scientific computing more open.</p>
<p>With {drake} you prepare a R script ‘plan’ that records all the functions to be executed. You then ‘make’ the plan to build the project from scratch or tore-run the outdated steps.</p>
<p>This post contains a very simple example of {drake} in action, but there’s so much more to it. Fortunately, there’s lots of resources:</p>
<ul>
<li><a href="https://ropenscilabs.github.io/drake-manual/">user manual</a></li>
<li><a href="https://ropensci.github.io/drake/">documentation</a></li>
<li><a href="https://github.com/krlmlr/drake-sib-zurich/blob/master/cheat-sheet.pdf">cheat sheet</a> by <a href="https://twitter.com/krlmlr">Kirill Müller</a></li>
<li><a href="https://aedobbyn.github.io/nyc-fires/index.html#1">‘drake for workflow happiness’</a> slides by <a href="https://dobb.ae/">Amanda Dobbyn</a> – which really embraces the <a href="">Drake meme</a></li>
</ul>
</div>
<div id="eggsample" class="section level1">
<h1>Eggsample</h1>
<p>Why do I care about {drake}?</p>
<p>I think there’s potential for using it in <a href="https://ukgovdatascience.github.io/rap-website/">Reproducible Analytical Pipelines</a> (RAP). RAP is a wholly code-based method for generating <a href="https://www.gov.uk/search/research-and-statistics">statistical reports in the UK government</a> to improve reproducibility and automation, while minimising errors and speeding-up production. RAP projects can be large and things can change during development, so {drake} could be a good fit.</p>
<p>I’ve made a very simple {drake} demo for an imaginary RAP project. The demo recreates a very small part of a <a href="https://www.gov.uk/government/statistics/egg-statistics">statistical publication that tracks UK egg production</a><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.</p>
<p>The code is on <a href="https://github.com/matt-dray/drake-egg-rap">GitHub</a>, along with an <a href="https://matt-dray.github.io/drake-egg-rap/egg-report.html">HTML version of the demo report</a>. The rest of this post describes the contents of the repo.</p>
<p>I’ve broken my explanation into five steps below:</p>
<ol style="list-style-type: decimal">
<li><a href="#prep">Prepare R scripts</a></li>
<li><a href="#source">Load the scripts</a></li>
<li><a href="#viz">Visualise</a></li>
<li><a href="#make">Make the plan</a></li>
<li><a href="#change">Make a change</a></li>
</ol>
<div id="prep" class="section level2">
<h2>1. Prepare the scripts</h2>
<p>The <a href="https://github.com/matt-dray/drake-egg-rap">demo repo</a> contains <a href="https://github.com/matt-dray/drake-egg-rap/tree/master/R">a folder</a> with three simple scripts<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> that contain the code needed for our analysis.</p>
<ol style="list-style-type: decimal">
<li><a href="https://github.com/matt-dray/drake-egg-rap/blob/master/R/packages.R"><code>packages.R</code></a> loads the packages we need for our analysis with <code>library()</code></li>
<li><a href="https://github.com/matt-dray/drake-egg-rap/blob/master/R/functions.R"><code>functions.R</code></a> contains our own custom functions</li>
<li><a href="https://github.com/matt-dray/drake-egg-rap/blob/master/R/plan.R"><code>plan.R</code></a> is where all the steps of the analysis are written</li>
</ol>
<p>These are all thigs you’ll find in a regular R analysis project.</p>
<p>The <code>plan.R</code> file needs a little more explanation. It contains the <code>drake_plan()</code> function, to which you pass the functions that make up your analysis. Our example plan is very simple, with only four functions:</p>
<pre class="r"><code>egg_plan &lt;- drake_plan(  # Create a drake_plan object called egg_plan
  
  # 1. Read the dataset
  raw_data = read_ods(
    path = &quot;data/eggs-packers-02may19a.ods&quot;,
    sheet = &quot;Packers_Annual&quot;,
    skip = 8
  ),  # separate each function with a comma
  
  # 2. Prepare the data with a bespoke function
  # from the functions.R file
  data = clean_data(raw_data),
  
  # 3. Generate a plot using a bespoke function
  # from the functions.R file
  plot = create_plot(data),
  
  # 4. Finally, render the R Markdown report
  # drake::knitr_in() marks the .Rmd file as a dependency
  # drake::file_out() marks the .HTML as an output
  report = rmarkdown::render(
    knitr_in(&quot;egg-report.Rmd&quot;),
    output_file = file_out(&quot;docs/egg-report.html&quot;),
    quiet = TRUE
  )

)</code></pre>
<p>You can put the functions in any order; {drake} takes care of the dependencies and works out which order in which to run them.</p>
<p>So now we’ve got everything we need: our packages, functions and the plan. How do we execute the plan? We can use a <a href="https://github.com/matt-dray/drake-egg-rap/blob/master/make.R">a small file called <code>make.R</code></a> that brings everything together.</p>
</div>
<div id="source" class="section level2">
<h2>2. Load the scripts</h2>
<p><code>make.R</code> starts with calls to <code>source()</code> each R script:</p>
<pre class="r"><code>source(packages.R)  # load the packages
source(functions.R)  # load the bespoke functions
source(plan.R)  # load the plan</code></pre>
<p>Sourcing the plan file means that the <code>drake_plan()</code> function inside is run, with the output being a data frame object<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a> called <code>egg_plan</code> in our example. It has columns called ‘target’ and ‘command’ and a row for each function in our analysis:</p>
<pre class="r"><code>egg_plan</code></pre>
<pre class="r"><code># A tibble: 4 x 2
  target   command                                                                           
  &lt;chr&gt;    &lt;expr&gt;                                                                            
1 raw_data read_ods(path = &quot;data/eggs-packers-02may19a.ods&quot;, sheet = &quot;Packers_Annual&quot;,      …
2 data     clean_data(raw_data)                                                             …
3 plot     create_plot(data)                                                                …
4 report   render(knitr_in(&quot;egg-report.Rmd&quot;), output_file = file_out(&quot;docs/egg-report.html&quot;)…</code></pre>
<p>The plan object acts like an instruction booklet, which can be read ‘to each target, apply the named command’. My simple example has only four instructions:</p>
<ol style="list-style-type: decimal">
<li>Read the raw data (the target) with <code>readODS::read_ods()</code> (the command)</li>
<li>Clean the data (target) with our <code>clean_data()</code> function (command)</li>
<li>Plot the data (target) with our <code>plot_data()</code> function (command)</li>
<li>Create an R Markdown report (target) with <code>rmarkdown::render()</code> (command)</li>
</ol>
<p>Before we execute this plan, we can take a look at what a dependency graph of these targets looks like.</p>
</div>
<div id="viz" class="section level2">
<h2>3. Visualise</h2>
<p>Having created the <code>egg_plan</code> object, we can extract information about it to a configuration (‘config’) list object. One element of the config is, for example, an <a href="https://igraph.org/">igraph</a> object that helps construct graphs from your workflow.</p>
<pre class="r"><code>egg_config &lt;- drake_config(egg_plan)</code></pre>
<p>A number of {drake} functions can take the config object and do something with the information inside it. In our case, we’re going to pass the config to <code>vis_drake_graph()</code>, which builds an interactive dependency graph based on {visNetwork}.</p>
<pre class="r"><code>vis_drake_graph(egg_config)</code></pre>
<p><a href="https://matt-dray.github.io/drake-egg-rap/dependency-graph.html">The interactive output</a> is handy for seeing dependencies at a glance. It’s shape-coded to show the target type (object, function, file) and colour-coded to show whether everything is up-to-date. At the moment it tells us that nothing is outdated; since we haven’t actually run the plan yet.</p>
</div>
<div id="make" class="section level2">
<h2>4. Make the plan</h2>
<p>Running the plan is as simple as:</p>
<pre class="r"><code>make(plan)</code></pre>
<p>This runs all the instructions laid out in the <code>plan</code> object; all the commands are run on the corresponding targets. In our case, this outputs an HTML report, since the last step of the plan was to render an R Markdown file.</p>
<p>Of course, re-running the plan straight away again does… nothing. No code needs to be re-executed if nothing’s changed! Remember that {drake} will identify changes for you and re-execute only the dependent parts.</p>
</div>
<div id="change" class="section level2">
<h2>5. Make a change</h2>
<p>So if anything at all changes in our data or code then the downstream targets will be out of sync. Let’s pretend we’ve changed a line of code in the <code>create_plot()</code> function, perhaps to alter its title. What do you think will happen?</p>
<p>Well, {drake} knows there’s been a change! Running <code>outdated(egg_config)</code> prints the file that’s been altered, plus all the impacted files that depend on it.</p>
<p>If we <a href="https://matt-dray.github.io/drake-egg-rap/dependency-graph-outdated.html">take another look at the visualisation now</a>, we can see that certain targets have been recoloured to show that they’re out of date.</p>
<p>Re-running the plan will now cause these targets to be regenerated. Targets that aren’t impacted by the change won’t be re-run.</p>
<p>Where are the targets stored that didn’t need to be recreated? Turns out that {drake} creates a <code>.drake/</code> folder to caches these objects and grabs then when needed.</p>
<p>Items can be pulled from this cache by the user with the the <code>loadd()</code> and <code>readd()</code> functions. For example, the R Markdown report in my example simply calls the rendered plot object from the cache using <code>readd()</code>. This can help keep the R Markdown file less cluttered and more readable.</p>
</div>
</div>
<div id="in-review" class="section level1">
<h1>In review</h1>
<p>This post has shown how {drake}:</p>
<ul>
<li>remembers the dependencies between the files of your analysis</li>
<li>only re-run what needs to be re-run</li>
</ul>
<p>Of course, <a href="https://ropenscilabs.github.io/drake-manual/">{drake} does a lot more than this</a>, but even this is enough help public servants to manage statistical reports that are more reliable and trustworthy.</p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>This publication could be a good candidate for RAP: content remains fairly similar between quarterly releases and it’s required to meet high standards of quality because it’s badged as <a href="https://www.statisticsauthority.gov.uk/osr/list-of-national-statistics/">National Statistics</a>.<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>You don’t have to restrict yourself to this configuration of scripts, but it can make it easier to handle your project.<a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p>It actually has multiple classes: <code>drake_plan</code>, <code>tbl_df</code>, <code>tbl</code> and <code>data.frame</code>.<a href="#fnref3" class="footnote-back">↩</a></p></li>
</ol>
</div>
