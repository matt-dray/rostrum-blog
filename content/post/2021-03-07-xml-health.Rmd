---
title: Apple Health and Nike Run Club with {xml2}
author: Matt Dray
date: '2021-03-23'
slug: xml-health
categories:
  - code
  - tutorial
tags:
  - apple
  - health
  - tidyverse
  - xml2
draft: yes
---


```{r setup, include=FALSE}
# https://bookdown.org/yihui/rmarkdown-cookbook/hook-truncate.html

# save the built-in output hook
hook_output <- knitr::knit_hooks$get("output")

# set a new output hook to truncate text output
knitr::knit_hooks$set(output = function(x, options) {
  if (!is.null(n <- options$out.lines)) {
    x <- xfun::split_lines(x)
    if (length(x) > n) {
      # truncate the output
      x <- c(head(x, n), "....\n")
    }
    x <- paste(x, collapse = "\n")
  }
  hook_output(x, options)
})
```

# tl;dr

You can export your [Apple Health](https://www.apple.com/uk/ios/health/) data as an XML file. This includes workouts linked from other apps, like [Nike Run Club](https://www.nike.com/nrc-app). I used the R packages [{xml2}](https://xml2.r-lib.org/index.html) and [the tidyverse](https://www.tidyverse.org/) to extract and clean my step counts and running activity.

# Positive reinforcement

My healthcare provider peeks at [the Apple Health app](https://www.apple.com/uk/ios/health/) and rewards me if I meet daily step-count targets. That's been trickier than usual during our serial lockdowns.

I took up running a year ago to help keep active and to keep the step counter ticking over. I record these runs on [the Nike Run Club app](https://www.nike.com/nrc-app), which I've linked to Apple Health.

I've in excess of 99 problems and at least two of them are related specifically to health data:

1. I don't think my healthcare supplier is rewarding my step counts correctly and I need evidence[^duncan]
1. It's not easy to get data out of the Nike Run Club app for further analysis

Luckily, you can export your Health app data, including any workouts linked from other apps. It's provided as XML, which is a sensible, structured storage format, but not necessarily that familiar to R users. 

This post looks at how to extract the data of interest and do something useful with it.

# Warm up

To export activity data from the Health app, as of iOS 14.4:

1. Open the Health app and tap your icon in the top right corner
1. Scroll down and tap 'Export All Health Data'
1. Tap 'Export' in the pop-up and the sharing tray will slide up for you to choose where to send the data

You'll get a zipped folder containing two XML files, `export_cda.xml` and `export.xml`, the latter of which contains your data. I stored and unzipped mine locally for the purposes of this post.

```{r unzip}
unzip(zipfile = "~/Downloads/export.zip", exdir = "~/Desktop/export/")
```

My unzipped folder was about 140 MB and contained about 5 years of data. 

# The right gear

[The {xml2} package](https://xml2.r-lib.org/index.html)[^xml2] is on CRAN and has the tools you need to read and reshape XML files. It may be familiar if you've ever done any webscraping with R.[^scrape]

We'll also iterate to accumulate with [the {purrr} package](https://purrr.tidyverse.org/) and do the ol' wrangle-jangle with some [other tidyverse packages](https://www.tidyverse.org/). 

```{r, library, message = FALSE}
library(xml2)       # read and wrangle XML
library(tidyverse)  # {purrr}, {dplyr}, {tidyr}
library(lubridate)  # date/time handling
library(forcats)    # handle factors
library(patchwork)  # arrange plots
```

The aptly named `xml2::read_xml()` function will let you read your `export.xml` file. 

```{r, read}
xml_in <- read_xml("~/Desktop/export/apple_health_export/export.xml")
```

Here's a truncated view of the file's structure:

```{r print-xml, out.lines=7}
xml_in
```

You can see metadata in the first few rows and then we get into the parts of the document that store the data. 

In this preview you can see each information stored in `<Record>` nodes. Each record is an individual entry in our activity log and has attributes like `type` (e.g. step count), `sourceName` (i.e. the device name) and `unit` (e.g. a count).

We're interested in extracting data from two types of node:

* `<Record>` for the step counts, as previewed above
* `<Workouts>`, which is where the Nike Run Club app data is stored

We can extract each of the records and workouts nodes by supplying to `xml2::xml_find_all()` the relevant xpaths, which are like addresses to different elements in the structure of the XML. We need only supply the simple xpaths `.//Record` and `.//Workouts` for our needs, which are at a high level in the structure of the file.

Once extracted, we can get the attributes---`type`, `sourceName`, etc, in our preview above---of each node using `xml2::xml_attr()`.

# Step to it

So, let's grab all the record nodes and preview the first one.

```{r rcds-find}
records <- xml_find_all(xml_in, ".//Record")
records[[1]]
```

Each record is a single 'bout' of activity as perceived by the app. You can see the first record is a step count from my phone on 21 June 2015, which lasted about two minutes and consisted of 28 steps.

For my purposes I only care about three attributes: the date[^time], the type of activity and the associated value. We can pass a named vector of each of attribute to `xml2::xml_attr()` using `purrr::map_dfr()` to collate the output into a rectangle.

```{r rcds-attrs}
records_df <- map_dfr(  # rowbind to dataframe
  c(date = "creationDate", type = "type", steps = "value"),
  ~xml_attr(records, .x)
)

glimpse(records_df)  # preview
```

So what `type` of activity has been logged?

```{r rcds-types}
distinct(records_df, type)
```

Aha, so we can isolate `HKQuantityTypeIdentifierStepCount`, then convert the date to datetime class and summarise the number of steps per day. I've also creating a new column that generates a 'point' value that my healthcare provider assigns to meeting certain step-count thresholds.

```{r rcds-wrangle}
records_out <- records_df %>% 
  filter(type == "HKQuantityTypeIdentifierStepCount") %>%
  mutate(date = as.Date(date), steps = as.integer(steps)) %>%
  group_by(date) %>%
  summarise(steps = sum(steps), .groups = "drop") %>% 
  mutate(
    points = case_when(
      steps > 12500 ~ 8L,
      steps > 10000 ~ 5L,
      steps > 7000 ~ 3L,
      TRUE ~ 0L
    )
  )

glimpse(records_out)
```

Excellent. Now I, tiny David, can sling this evidence into the eye of the behemoth cyclops that is my healthcare provider.

## On a walkabout

There's a million ways to explore these data, but I first wondered how the frequency of step counts might have changed in the year up to 23 March 2020---[the announcement of the UK's first lockdown](https://fullfact.org/health/coronavirus-lockdown-hancock-claim/)---and in the year since.

```{r wo-plot, fig.alt="Side-by-side histograms of step counts before and after lockdown. Before lockdown, a bimodal distribution with peaks at about 3k and 10k steps. After lockdown, a big peak at about 1k and a peak at about 6k with a tail to about 20k."}
records_out %>% 
  mutate(
    covid_year = case_when(
      date >= "2020-03-23" & date < "2021-03-23" ~ "After COVID lockdown",
      date >= "2019-03-23" & date < "2020-03-23" ~ "Before COVID lockdown", 
      TRUE ~ NA_character_
    )
  ) %>% 
  filter(!is.na(covid_year)) %>% 
  ggplot() + 
  geom_histogram(aes(steps / 1000), binwidth = 1) + 
  facet_grid(~fct_rev(covid_year)) +
  labs(x = "Steps (thousands)", y = "Count") +
  theme_minimal()
```

Not a surprise, but interesting to see it visually: there's been a far higher proportion of days with a very small number of steps in the lockdown year. The second peak of the bimodal distribution has also regressed to a lower value. This is understandable: I used to walk on parts of my commute and lunchtimes, whereas my

# Jog on

Ideally this would come directly out of the Nike Run App, but you can't have it all. Remember that the run data is stored in the `<Workout>` node.

```{r wo-find}
workouts <- xml_find_all(xml_in, ".//Workout")
workouts[[1]]
```

The attributes are slightly different for workouts compared to records, and there's also some child nodes with further information. This time I care about the activity type (just runs), the date, the distance and the time taken. Unfortunately there isn't any data on splits, which means I can't calculate my record times for each distance. Ah well, we can pass the attributes we do have into the mapping function.

```{r wo-attrs}
workouts_df <- map_dfr(
  c(date = "creationDate", type = "workoutActivityType",
    km = "totalDistance", dur = "duration"),
  ~xml_attr(workouts, .x)
) 

glimpse(workouts_df)
```

Notice something awkward? The duration is in minutes, but it has a decimal value. I wrangled this by taking the decimal part and converting it to seconds, then adding it back to the seconds into the whole number minutes. Speaking of time, I've also computed a rough time per distance metric. In both these cases I used `lubridate::seconds_to_period()` to generate a period-class value that converts to days, hours, minutes and seconds as required.

```{r wo-wrangle}
workouts_out <- workouts_df %>% 
  filter(type == "HKWorkoutActivityTypeRunning") %>% 
  mutate(
    date = as.Date(date),
    across(c(dur, km), as.numeric),
    dur = round(dur, 3)
  ) %>% 
  separate(col = dur, into = c("mins", "mins_dec"), sep = "\\.") %>% 
  transmute(
    date, km,
    s = (as.numeric(mins) * 60) + ((as.numeric(mins_dec) / 1000) * 60),
    mins = seconds_to_period(round(s)),
    avg_pace = seconds_to_period(round(s / km)),
    s = round(s), km = round(km, 2)
  )

tail(workouts_out)
```
You can see the last few trips in the preview. The period-class columns gives us the timings in minutes (`M`) and seconds (`S`), which is more convenient that looking at the number of seconds alone.

## High-vis apparel

There's even more ways to explore these data to compared ot the steps data. Here's some ideas for how you might delve in.

```{r wo-summarise}
workouts_out %>% 
  filter(km > 1) %>% 
  summarise(
    `Interval (days)` = max(date) - min(date),
    `Total count` = n(),
    `Days per run` = round(`Interval (days)` / `Total count`, 1),
    `Total time` = seconds_to_period(sum(s)), 
    `Total distance (km)` = round(sum(km)),
    `Furthest distance (km)` = max(km),
    `Best average pace` = seconds_to_period(min(round(s / km)))
  ) %>% 
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(everything(), names_to = "Summary", values_to = "Value") %>% 
  knitr::kable()
```
I'm interested in what my pattern of run distance looks like.

On the left are plots for run distances by date (above) and cumulative distance by date (below). The histogram on the right shows the frequency of run distances in 1 km bins.

```{r}
p1 <- ggplot(workouts_out) + 
  geom_point(aes(date, km), shape = 1) +
  labs(y = "") +
  theme_light()

p2 <- workouts_out %>% 
  mutate(km_cum = cumsum(km)) %>% 
  ggplot() +
  geom_line(aes(date, km_cum)) +
  labs(x = "km", y = "") +
  theme_light()

p3 <- ggplot(workouts_out) +
  geom_histogram(aes(km), binwidth = 1) +
  theme_light()

(p1 / p2) | p3
```

You can see I started with a lot of 5 km runs in April and May 2020, before branching out to 10 km or more. I've been pretty consistent in running every two or three days and that's reflected in the chart of cumulative distance. The histogram shows that most runs have been just above 5 km, with another peak just above 10 km. That makes sense: I intentionally set out to run at least these distances.

# Cool down

After starting this post, I noticed that Mark Koester has awritten a [more in-depth post](http://www.markwk.com/data-analysis-for-apple-health.html) about Apple Health data, with a focus on Python code for achieving a similar goal. It notes third-party tools like [QS Access](https://apps.apple.com/gb/app/qs-access/id920297614) for extracting data into a friendlier CSV format, for example.

[^duncan]: In this vein, you can also [use your Google Maps data to convince the church to marry you](https://nacnudus.github.io/duncangarmonsway/posts/2019-04-22-get-me-to-the-church-on-time-with-r-spatial/), as per Duncan Garmonsway. 
[^xml2]: '2' because it's a binding to [libxml2](http://xmlsoft.org/), but perhaps also because it's the spiritual successor to [{XML}](https://CRAN.R-project.org/package=XML), which is R's veteran package for XML handling.
[^scrape]: For example, see previous posts about [travelling the NBA](https://www.rostrum.blog/2018/12/24/nba-travel/) and [polite webscraping](https://www.rostrum.blog/2019/03/04/polite-webscrape/).
[^time]: Luckily, I live at +0000, so no time-related data wrangling is required for me.