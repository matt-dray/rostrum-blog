---
title: Mail merge in 2018 with R
author: Matt Dray
date: '2018-06-26'
categories:
  - R
  - pop culture
tags:
  - dawsons-creek
  - reproducibility
  - iteration
slug: mail-merge
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = FALSE, message = FALSE)
```

<span style="color:lightgray">Matt Dray</span>

<img src="https://media.giphy.com/media/L1PqqvVFtQiEU/giphy.gif" alt="Gif of cool guy ready to surf the web" width=75%>

[Clip art](http://hddfhm.com/clip-art/clipart-word-2000.html)! [Fax machines](http://www.bbc.com/future/story/20150224-why-the-fax-machine-wont-die)! [CD-ROMs](https://archive.org/download/encarta95/encarta95.jpg)! [Dial-up modems](https://gizmodo.com/i-used-a-56k-modem-for-a-week-and-it-was-hell-on-earth-1693124620)! [The World Wide Web](http://www.cs.trinity.edu/~thicks/Tutorials/WebEditor-Composer0-Install/Netscape1.gif)! [*Mail merge*](https://en.wikipedia.org/wiki/Mail_merge)*!*

These exotic terms give me flashbacks to computer class at the turn of the millennium.

The last one -- mail merge -- is a technique you might still need to use. It involves filling a template document, typically a template letter, with information from unique cases in a database.

I've helped out some colleagues with report autogeneration a few times recently (mostly so no-one has to waste hours copy-pasting values into a template by hand). R seems a natural choice to do this; it has the obvious advantage of reproducibility and allows you to process the data as you see fit.

And to keep to theme, I've got a dataset composed of details for each episode of the first season of the hit late-90s-early-2000s-teen-angst-love-triangle-articulate-children masterpiece that is [*Dawson's Creek*](https://en.wikipedia.org/wiki/Dawson%27s_Creek), via [Wikipedia](https://en.wikipedia.org/wiki/List_of_Dawson%27s_Creek_episodes#Season_1:_1998).

I've created [an accompanying GitHub repository](https://github.com/matt-dray/mail-merge-2018) where you can download or clone a whole R Project to replicate the approach used in this post.

# Approach

We'll make an R Markdown template and fill it with data for each episode of *Dawson's Creek* by looping through each of them in turn. Each will be rendered to a .docx file and formatted according to a style template that we've created and specified. 

I don't claim this to be the most efficient method, but it's useful for beginners and, well, it works.

Your working directory should contain three important files:

* your letter or report template preapred in R Markdown (.Rmd)
* your style-reference document (.docx), in a file called 'style'
* a script file for reading your data and looping through each element (.R)

The folder should also contain:

* your R Project file (.Rproj)
* a folder to hold the output files (e.g. 'output')
* any additional folders you need for input files (e.g. 'data' and 'images')
* a README file to explain the purpose of your work (.md or something)

<img src="/post/2018-06-26-mail-merge-in-2018_files/directory_structure.PNG" alt="Screenshot of the folders needed in the directory" width=50%>

## The template

Your template is an R Markdown file containing the actual content of your letter or report. In short, R Markdown files allow you to write plain text formatted with special symbols and insert R code inline or in 'chunks'. You can [find out more about R Markdown from the RStudio website](https://rmarkdown.rstudio.com/). I've also written [a short guide to writing R Markdown documents](https://matt-dray.github.io/knitting-club/) and created [a small set of slides](https://matt-dray.github.io/quick-rmd/#1), both with beginners in mind.

Throughout this template you should refer to the subset of data for which you're creating reports. In other words, episodes of the *Dawson's Creek* dataset that have been subset to a one-row dataframe for each episode called `episode`. 

So it's the `episode` object that the template should refer to.

The template itself should start with a YAML header section that indicates the output type (`word_document`) and reference style (at the path `style/dawson_style.docx` in our case). You can also add title, name, etc, to this section if you like.

```{r eval=FALSE}
---
output:
  word_document:
    reference_docx: style/dawson_style.docx
---
```

You're then free to add script to the body of the R Markdown file as you would normally. For example, the following code in the temaplte will be filled with each episode's production code and title as we go through the loop:

```{r eval=FALSE}
`r paste0(episode$production_code, ": '", episode$title, "'")`
```

We can also do someting like this inside an R Markdown code chunk to get a table containing information about the episodes:

```{r eval=FALSE}
episode %>% 
  select(  # choose these columns for display
    Season = season,
    `Number in season` = number_in_season,
    `Number in series` = number_in_series,
    `Original air date` = original_air_date
  ) %>% 
  kable()  # print to output table
```

## The style

The default output is *okay* when an R Markdown file rendered a .docx. You can create a separate Word document that contains modified styles to suit your theme. 

You can read more about creating a style document in [Richard Layton's 'happy collaboration with Rmd to docx'](https://rmarkdown.rstudio.com/articles_docx.html) on the R Markdown site. Basically you create a fake document in which you've set the formatting for each style element (title, third-level header, paragraph text, etc), store it in your working repository and refer to it from the YAML of your R Markdown report (see secton above).

Here I stole and modified a template from [the `dfeR` package](https://dfe-analytical-services.github.io/dfeR/), which is intended for use in presenting official statistics.

<img src="/post/2018-06-26-mail-merge-in-2018_files/dawson_style.PNG" alt="Screenshot of the .docx style document" width=75%>

## Read/loop

We have the template and style in place.

You should have an R script (.R) file that (1) reads the data and (2) executes a loop that applies episode data to the template and saves it with a unique name to a specified subfolder. You'll get one document for each unique element, so we'll get 13 because there are 13 rows in our dataset; one for each episode.

After reading in the data with something like `data <- readr::read_csv(file = "data/dawsons-creek-season-1.csv")` you can write a loop that looks something like this:

```{r eval=FALSE}
for (i in data$production_code){  # for each unique episode...
  
  # Isolate that episode from the dataset
  
  episode <- data[data$production_code == i, ]  
  
  # The one-row dataframe object 'episode' we just created will be used as the
  # source for filling the details in on the template file
  
  # Now render ('knit') the R Markdown file to Word format, name it and save it
  
  render(
    input = "01_template.rmd",  # path to the template
    output_file = paste0("episode_", i, ".docx"),  # name the output
    output_dir = "output"  # folder in which to put the output file
  )

}  # end of loop
```

You can see we're:

* looping through unique values from the `production_code` column
* subsetting the `data` object to isolate the production code for the ith element
* rendering the template document using the `episode` data
* giving the file a name that incorporates the production code
* saving this to the 'output' folder in our project directory

# Execute

So now you have an R Project folder with, among other things, an R Markdown template report to be populated and a script that reads your data and loops through each element to fill that template. Run the code in the read/loop script.

The files will be rendered in turn according to the formatting in the style document, and added one by one to the output folder. It's fun to open this folder and watch them pop into existence.

Congratulations! You now have a separate file that contains the information for each of the episodes in season 1 of *Dawson's Creek*! Make sure to share with your friends (assuming you're not in an awkward love triangle).

<img src="/post/2018-06-26-mail-merge-in-2018_files/dawson101.PNG" alt="Screenshot of the first report showing episode 101 of Dawson's Creek" width=75%>
<img src="/post/2018-06-26-mail-merge-in-2018_files/dawson102.PNG" alt="Screenshot of the first report showing episode 102 of Dawson's Creek" width=75%>

# R session info

*I don't wanna wait... for this post to be oooover*

<img src="https://media.giphy.com/media/3oz8xUK8V7suY7W9SE/giphy.gif" alt="Gif of the titular Dawson crying" width=50%>

```{r session_info}
devtools::session_info()
```