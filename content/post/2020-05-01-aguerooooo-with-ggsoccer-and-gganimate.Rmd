---
title: AGUEROOOOO with {ggsoccer} and {gganimate}
author: Matt Dray
date: '2020-05-01'
slug: aguerooooo
categories:
  - code
  - data-viz
  - tutorial
tags:
  - football
  - gganimate
  - ggsoccer
  - ggplot2
  - soccer
  - sport
draft: yes
---

```{r full-code, message=FALSE, warning=FALSE, echo=FALSE}
# Packages
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
library(ggsoccer) # Plot Soccer Event Data
library(gganimate) # A Grammar of Animated Graphics
library(tibble) # Simple Data Frames

# Player position data
players <- tribble(
  
  ~frame, ~name, ~x, ~y,  # column names
  
  1, "De Jong", 50, 50,  # advances from own half
  2, "De Jong", 56, 50,  # advances into oppo half
  3, "De Jong", 64, 50,  # passes to Aguero
  4, "De Jong", 64, 50,  # off the ball
  5, "De Jong", 64, 50,  # off the ball
  6, "De Jong", 64, 50,  # off the ball
  7, "De Jong", 64, 50,  # off the ball
  8, "De Jong", 64, 50,  # off the ball
  
  1, "Agüero", 85, 70, # diagonal run to meet ball from De Jong
  2, "Agüero", 80, 65, # diagonal run to meet ball from De Jong
  3, "Agüero", 75, 60, # receives pass from De Jong
  4, "Agüero", 76, 63, # beats defender, passes to Balotelli
  5, "Agüero", 80, 50, # advances to edge of box
  6, "Agüero", 87, 38, # receives pass from Ballotelli
  7, "Agüero", 93, 36, # shot
  8, "Agüero", 94, 33, # goal
  
  1, "Balotelli", 83, 61, # waiting on edge of box
  2, "Balotelli", 83, 61, # waiting on edge of box
  3, "Balotelli", 83, 61, # waiting on edge of box
  4, "Balotelli", 83, 57, # waiting on edge of box
  5, "Balotelli", 83, 55, # recieves pass from Aguero
  6, "Balotelli", 83, 55, # passes to Aguero
  7, "Balotelli", 83, 54, # off the ball
  8, "Balotelli", 83, 54, # off the ball
  
)

# Ball position data
ball <- tribble(
  
  ~frame, ~x, ~y,
  
  1,  51, 50,  # De Jong possession
  2,  57, 50,  # De Jong pass
  3,  74, 60,  # receievd by Aguero
  4,  77, 63,  # Aguero pass
  5,  83, 54,  # received by Balotelli
  6,  88, 38,  # received by Aguero
  7,  94, 36,  # Aguero shot
  8, 100, 50   # goal 

)

# Plot all the data
plot <- 
  ggplot() +       # blank canvas
  annotate_pitch(  # plot 100 * 100 unit pitch 
    colour = "white", fill = "#7fc47f", limits = FALSE
  ) +
  theme_pitch() +  # theme removes plotting elements
  coord_flip(      # rotate and crop pitch
    xlim = c(49, 101), ylim = c(-12, 112)
  ) +
  geom_point(      # add ball data
    data = ball,
    aes(x = x, y = 100 - y),
    colour = "black", fill = "white", pch = 21, size = 2
  ) +
  geom_point(      # add player data
    data = players, 
    aes(x = x, y = 100 - y), 
    colour = "black", fill = "skyblue", pch = 21, size = 4
  ) +
  geom_text(       # add player labels
    data = players, aes(x = x, y = 100 - y, label = name),
    hjust = -0.2, nudge_x = 1
  ) +
  ggtitle(         # add title
    label = "MCY [3]-2 QPR",
    subtitle = "93:20 GOAL Sergio Agüero"
  )

# Animate the plot
animation <-
  plot +                   # the plot object
  transition_states(
    frame,                 # time-step variable
    state_length = 0.01,   # duration of frame
    transition_length = 1, # duration between frames
    wrap = FALSE           # restart, don't loop
  )

animate(animation)
```

# tl;dr

I used R to animate the goal that won Manchester City the 2011/12 Premier League title in breathtaking fashion.

Inspired by Ryo Nakagawara, who makes awesome R-related soccer content that you can find on [his site](https://ryo-n7.github.io/) and [on Twitter](https://twitter.com/R_by_Ryo).[^brickr]

# Football?

Soccer has run dry.

Leagues have [been cancelled](https://www.bbc.co.uk/sport/football/52418048) or [decided on a contentious points-per-game basis](https://www.bbc.co.uk/sport/football/52484926). The fate of the 2019/20 Premier League season is still unknown.

I figured it would be good to revisit the season where the title was decided emphatically, in literally the last couple of minutes of the last game of the season.

## The game

City and United were level on points at the top of the table as they entered their final matches of the season.

| Pos | Team | Played | GD | Points |
|--:|:--|--:|--:|--:|
| 1 | Manchester City | 37 | +63 | 86 |
| 2 | Manchester United | 37 | +55 | 86 |

As the game entered the final minutes, City somehow found themselves 2-1 down to a battered Queens Park Rangers side. A towering Edin Dzeko header brought the game to a tie after 92 minutes, but it wouldn't be enough to win the title; one more goal was needed.

Meanwhile, Manchester United had won their concurrent game and had every right to think the trophy was theirs.

But at 93 minutes, City's Nigel De Jong burst into the opposition half. Sergio Agüero steped forward, received the ball and beat his man. He passed to Mario Balotelli and continued his run into the box. Balotelli slid to the ground to play the ball into Agüero's path.

Aguero received the ball, beat a slide tackle and smashed the ball into the goal.

| Pos | Team | Played | GD | Points |
|--:|:--|--:|--:|--:|
| 1 | Manchester City | 37 | +64 | 89 |
| 2 | Manchester United | 37 | +56 | 89 |

# Reliving the moment

So the sensible thing to do is to use R to make a gif of the player movements in the build-up to the goal.

Three packages are needed:

* [{ggplot2}](https://ggplot2.tidyverse.org/), created by [Hadley Wickham](http://hadley.nz/), to provide the plotting framework
* [{ggsoccer}](https://torvaney.github.io/ggsoccer/), by [Ben Torvaney](http://www.statsandsnakeoil.com/), for the grid and pitch theme
* [{gganimate}](https://gganimate.com/), by [Thomas Lin Pedersen](https://www.data-imaginist.com/), for animating each step and interpolating between them

```{r pkgs, eval=FALSE}
# Load packages
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
library(ggsoccer) # Plot Soccer Event Data
library(gganimate) # A Grammar of Animated Graphics
library(tibble) # Simple Data Frames
```

You can also load {tibble} to use `tribble()`, but this isn't a requirement.

An aside: I used [the {annotater} RStudio Addin](https://luisdva.github.io/rstats/annotater/) by [Luis D Verde](https://luisdva.github.io/) to annotate these library calls.

# Points

You need to provide step-by-step coordinates for player positions on a 100- by 100-unit pitch, as provided by default in {ggsoccer}.

[Opta](https://www.optasports.com/) is a private company with a premium service for player-tracking data. My approach was more... artisanal. I just watched some grainy YouTube videos and roughly guessed where the players were.

A really nice tool to make the process easier is the [soccer event logger](https://torvaney.github.io/projects/tracker) by Ben Torvaney, creator of {ggsoccer}.

I created the data frames using `tribble()` from the {tibble} package because I found it easier to input the data in a row-wise fashion.

## Players

The first data frame contains each player's coordinates, with a row for each frame of the final animation. I added the player name so it could be used as a label.

I chose to focus on the three active players in the build-up to the goal. This made the final graphic clearer, yes, but more importantly it meant I had fewer data points to input.

```{r players, eval=FALSE}
# Player position data
players <- tribble(
  
  ~frame, ~name, ~x, ~y,  # column names
  
  1, "De Jong", 50, 50,  # advances from own half
  2, "De Jong", 56, 50,  # advances into oppo half
  3, "De Jong", 64, 50,  # passes to Aguero
  4, "De Jong", 64, 50,  # off the ball
  5, "De Jong", 64, 50,  # off the ball
  6, "De Jong", 64, 50,  # off the ball
  7, "De Jong", 64, 50,  # off the ball
  8, "De Jong", 64, 50,  # off the ball
  
  1, "Agüero", 85, 70, # diagonal run to meet ball from De Jong
  2, "Agüero", 80, 65, # diagonal run to meet ball from De Jong
  3, "Agüero", 75, 60, # receives pass from De Jong
  4, "Agüero", 76, 63, # beats defender, passes to Balotelli
  5, "Agüero", 80, 50, # advances to edge of box
  6, "Agüero", 87, 38, # receives pass from Ballotelli
  7, "Agüero", 93, 36, # shot
  8, "Agüero", 94, 33, # goal
  
  1, "Balotelli", 83, 61, # waiting on edge of box
  2, "Balotelli", 83, 61, # waiting on edge of box
  3, "Balotelli", 83, 61, # waiting on edge of box
  4, "Balotelli", 83, 57, # waiting on edge of box
  5, "Balotelli", 83, 55, # recieves pass from Aguero
  6, "Balotelli", 83, 55, # passes to Aguero
  7, "Balotelli", 83, 54, # off the ball
  8, "Balotelli", 83, 54, # off the ball
  
)
```

You can see that each player has a coordinates for each frame.

```{r player-preview}
# Preview the data frame
head(players[order(players$frame), ])
```

## Ball

I produced the coordinate data for the ball in a separate data frame. This makes it easier to specify and modify separately the points in the plot.

```{r ball, eval=FALSE}
# Ball position data
ball <- tribble(
  
  ~frame, ~x, ~y,
  
  1,  51, 50,  # De Jong possession
  2,  57, 50,  # De Jong pass
  3,  74, 60,  # receievd by Aguero
  4,  77, 63,  # Aguero pass
  5,  83, 54,  # received by Balotelli
  6,  88, 38,  # received by Aguero
  7,  94, 36,  # Aguero shot
  8, 100, 50   # goal 

)
```

# Graphics

The first step in producing the animation is to create a single plot object that contains all the points. {gganimate} takes the object and animates it frame by frame, interpolating the data points between each time step.

## Plot

To produce the plot object:

1. Plot the pitch area
1. Add ball data first so the points will appear 'under' the player points
1. Add player points and labels
1. Add a title

```{r plot, eval=FALSE}
# Plot all the data
plot <- 
  ggplot() +       # blank canvas
  annotate_pitch(  # plot 100 * 100 unit pitch 
    colour = "white", fill = "#7fc47f", limits = FALSE
  ) +
  theme_pitch() +  # theme removes plotting elements
  coord_flip(      # rotate and crop pitch
    xlim = c(49, 101), ylim = c(-12, 112)
  ) +
  geom_point(      # add ball data
    data = ball,
    aes(x = x, y = 100 - y),
    colour = "black", fill = "white", pch = 21, size = 2
  ) +
  geom_point(      # add player data
    data = players, 
    aes(x = x, y = 100 - y), 
    colour = "black", fill = "skyblue", pch = 21, size = 4
  ) +
  geom_text(       # add player labels
    data = players, aes(x = x, y = 100 - y, label = name),
    hjust = -0.2, nudge_x = 1
  ) +
  ggtitle(         # add title
    label = "MCY [3]-2 QPR",
    subtitle = "93:20 GOAL Sergio Agüero"
  )
```

Note that the y-aesthetic is `100 - y` because the plot has been rotated.

The `plot` object contains everything that {gganimate} needs to render the animation. You wouldn't plot this object as-is, but here's what it looks like:

```{r}
plot
```

## Animate

The `transition_states()` function from {gganimate} builds on top of the `plot` object. Here, I specified the time-step variable; the durations for showing the frame and the interpolated frames between; and whether or not the animation should loop back to the start. 

```{r animate, eval=FALSE}
# Animate the plot
animation <-
  plot +                   # the plot object
  transition_states(
    frame,                 # time-step variable
    state_length = 0.01,   # duration of frame
    transition_length = 1, # duration between frames
    wrap = FALSE           # restart, don't loop
  )
```

The `animate()` function renders the animation.

```{r}
animate(animation)
```

AGÜEROOOOO!

You can save the result as a gif with `anim_save()`, which works like `ggsave()` from {ggplot2}: the default is to save the latest animation to your working directory.

```{r save, eval=FALSE}
anim_save("9320.gif")
```

---
<details><summary>Session info</summary>
```{r sessioninfo, echo=FALSE}
sessioninfo::session_info()
```
</details>

[^brickr]: Also a fellow builder of [{brickr} soccer players](https://twitter.com/R_by_Ryo/status/1134789739301621760?s=20).