---
title: Waggle dance with ggbeeswarm and emoGG
author: Matt Dray
date: '2018-11-21'
slug: waggle-dance
categories:
  - dataviz
  - R
tags:
  - ggbeeswarm
  - ggplot2
  - magick
  - bees
  - entomology
draft: yes
---

# Plot continuos Y and categorical X

A boxplot lets you show continuous data split by categories, but it hides the data points and doesn't tell you much about distribution. A violin chart will show the distribution but you still don't know about the density of data.

Stripcharts show the data for each category as data points. The points can be layered on top of each other where they take the same Y value and can be stretched arbitrarily along the X axis.

If you don't have too much data, or if you sample it, you can stop the data points in a stripchart from overlapping and instead line them up side by side where they take the same value (note that there are several ways to 'stack' the points). This is called a 'beeswarm'.

Why? Probably because the cloud of data you're plotting looks a bit like a swarm of bees.

# Obvious next step

We can test this theory by plotting the points as *actual bees*, lol. Well, *emoji* bees. Duncan (of [tidyxl](https://nacnudus.github.io/tidyxl/) and [unpivotr](https://nacnudus.github.io/unpivotr/) fame) did exactly this and tweeted the plot and code.

```{r duncan_tweet_code, echo=FALSE}
blogdown::shortcode("tweet", "1063147214124580866")
```

To summarise, Duncan did this by hacking [emojis via `emoGG`](https://github.com/dill/emoGG) into [`ggbeeswarm`'s `geom_beeswarm()` function](https://github.com/eclarke/ggbeeswarm) to create `gg_beeswarm_emoji()` (patent pending).

# Obvious next next step

Wouldn't it be better if the little emoji bees moved around a little bit?

I cheated a little bit and recoded the `geom_quasirandom()` function from `ggbeeswarm` instead of `geom_beeswarm()`. Why? Beeswarm plots have an inherent order and neatness to them. *That is not becoming of a beeswarm*. Instead, `geom_quasirandom()` gives you some 'random' jitter each time you plot the data. 

So we can plot the same data several times and stack the images into a gif. One easy way to do this is via [the `magick` package](https://cran.r-project.org/web/packages/magick/vignettes/intro.html), a re-engineering of [the open-source ImageMagick sute of tools](https://www.imagemagick.org/script/index.php) from [Jeroen Ooms](https://twitter.com/opencpu) at [ROpenSci](https://ropensci.org/).

# Code

Load the packages.

```{r packages, message=FALSE}
library(ggplot2)
library(ggbeeswarm)
library(emoGG)  # remotes::install_github("dill/emoGG")
library(magick)
```

Recode the `geom_quasirandom()` to display emoji. [Idea stolen from Duncan's tweet](https://twitter.com/nacnudus/status/1063147214124580866).

```{r geom_quasirandom}
geom_quasi_emoji <- function (mapping = NULL, data = NULL, width = NULL, varwidth = FALSE, 
          bandwidth = 0.5, nbins = NULL, method = "quasirandom", groupOnX = NULL, 
          dodge.width = 0, stat = "identity", position = "quasirandom", 
          na.rm = FALSE, show.legend = NA, inherit.aes = TRUE, emoji = "1f4l1d", ...) {
  
  img <- emoji_get(emoji)[[1]]
  
  position <- position_quasirandom(width = width, varwidth = varwidth, 
                                   bandwidth = bandwidth, nbins = nbins, method = method, 
                                   groupOnX = groupOnX, dodge.width = dodge.width)
  
  ggplot2::layer(data = data, mapping = mapping, stat = stat, 
                 geom = emoGG:::GeomEmoji, position = position, show.legend = show.legend, 
                 inherit.aes = inherit.aes, params = list(na.rm = na.rm, img = img, ...))
}
```

It makes sense to use the data that Duncan generated so we can compare the static plot to the animated one.

```{r data}
swarm <- data.frame(
  "variable" = rep(c("runif", "rnorm"), each = 100),
  "value" = c(runif(100, min = -3, max = 3), rnorm(100))
)
```

Let's define what our plot should look like. `method = "pseudorandom"` is the bit that gives us the jittering.

```{r ggplot}
plot <- ggplot(swarm, aes(variable, value)) +
  geom_quasi_emoji(emoji = "1f41d", method = "pseudorandom") +
  theme(panel.background = element_rect(fill = "skyblue")) +
  ggtitle("WAGGLE DANCE")
```

Now we can create a few versions of thi plot with different jittering. The plots are magick objects made with `image_graph()` from `magick`.

```{r plot_panels}
my_res = 100
my_width = 400
my_height = 400
time_point <- paste0("t", 1:4)

for (i in seq_along(time_point)) {

  plot_object <- image_graph(width = my_width, height = my_height, res = my_res)
  
  assign(time_point[i], plot_object)
  
  ggplot(swarm, aes(variable, value)) +
    geom_quasi_emoji(emoji = "1f41d", method = "pseudorandom") +
    theme(panel.background = element_rect(fill = "skyblue")) +
    ggtitle("WAGGLE DANCE")
  
  dev.off()
  
}
```

And now `image_animate()` can be used to combine those magick objects into an animation.

```{r animate}
waggle_dance <- image_animate(c(t1, t2, t3, t4), fps = 10)
waggle_dance
```

And we can save this as a gif with `image_write()`.

```{r save, eval=FALSE}
image_write(waggle_dance, "~/Desktop/waggle_dance.gif")
```