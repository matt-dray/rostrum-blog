---
title: The NBA Northwest Division with gmapsdistance
author: Matt Dray
date: '2018-12-18'
slug: nba-travel
categories:
  - R
tags:
  - NBA
  - gmapsdistance
  - dplyr
  - rvest
  - stringr
draft: yes
---



<p>Matt Dray (<a href="https://www.twitter.com/mattdray">@mattdray</a>)</p>
<div class="figure">
<img src="https://media.giphy.com/media/GOIl4CelYNleM/giphy.gif" alt="Jazz’s Stockton to Malone for the dunk (via Giphy)" />
<p class="caption">Jazz’s Stockton to Malone for the dunk (<a href="https://giphy.com/gifs/vintage-basketball-GOIl4CelYNleM">via Giphy</a>)</p>
</div>
<div id="the-nba" class="section level1">
<h1>The NBA</h1>
<p>The USA is quite big.</p>
<p>So it makes sense that the USA’s National Basketball Association (NBA) organised their teams geographically: two ‘conferences’ – Western and Eastern – with three ‘divisions’ of five teams each, right?</p>
<p>Yes, for the Central division of the Eastern Conference. It contains the Chicago Bulls, Cleveland Cavaliers, Detroit Pistons, Indiana Pacers and Milwaukee Bucks – cities clustered near Lakes Michigan and Erie.</p>
<p>But also no, not for the Northwest Division of the Western Conference. This stretches from Portland Trail Blazers in the Pacific Northwest to Oklahoma City Thunder, which is actually in the country’s south-central region. Far from clustering, Utah Jazz and Colorado’s Denver Nuggets sit on a line between these two. The fifth team? That’s Minnesota Timberwolves, which could be mistaken for part of the Central Division</p>
<p>What does this mean for the travelling basketball fans?</p>
</div>
<div id="travel-time-with-gmapsdistance" class="section level1">
<h1>Travel time with <code>gmapsdistance</code></h1>
<p>The R package <a href="https://cran.r-project.org/web/packages/gmapsdistance/index.html"><code>gmapsdistance</code></a> was written by Rodrigo Azuero, Demetrio Rodriguez and David Zarruk. It wraps the <a href="https://www.google.co.uk/maps">Google Maps</a> <a href="https://medium.freecodecamp.org/what-is-an-api-in-english-please-b880a3214a82">API</a>. You can use it to query origin and destination points for travel distance (metres) and duration (seconds) for several modes of travel: on foot, by car, by public transport, or by bicycle (for parts of North America only).</p>
<p>We need an API key for Google Maps. This helps prevent misuse of their service and tracks your access. Your first $300 is free.</p>
<p>The process is outlined in detail on <a href="https://developers.google.com/maps/documentation/distance-matrix/get-api-key#key">the Google developer pages</a>. <a href="https://cloud.google.com/maps-platform/">Go to the website</a> and follow the instructions.</p>
<p>Keep this key safe for now; we’ll read it in later.</p>
</div>
<div id="get-data" class="section level1">
<h1>Get data</h1>
<p>We can use <a href="https://github.com/hadley/rvest">Hadley Wickham’s <code>rvest</code> package</a> to scrape the <a href="https://en.wikipedia.org/wiki/National_Basketball_Association">Wikipedia page for the NBA)</a>, which contains a table of teams and locations.</p>
<pre class="r"><code>library(dplyr)  # data manipulation
library(rvest)  # web scraping
library(stringr)  # string manipulation
library(knitr)  # to print our tables
library(tidyr)  # tidying dataframes</code></pre>
<p>Then we’ll create objects that define the HTML for the web page and the table we want. The latter is defined using a CSS selector or, as in our case, an xpath. Think of these as ‘addresses’ for HTML content. You can use the ‘inspect’ function in your browser or <a href="https://selectorgadget.com/">the selectorgadget browser extension</a> to get this information.</p>
<pre class="r"><code># Read the HTML from a specified web URL
html &lt;- read_html(&quot;https://en.wikipedia.org/wiki/National_Basketball_Association&quot;)

# Use selectorgadget or your browser&#39;s &#39;inspect&#39; mode to get xpath
table_xpath &lt;- &#39;//*[@id=&quot;mw-content-text&quot;]/div/table[4]&#39;</code></pre>
<p>Now we can collect the table and manipulate it.</p>
<p>We could use the latitude and longitude from this table as our origin and destination points, but the arena name, city and state will be enough. We can create a column in our data in the form <code>arena+city+state</code>, which is the format required by Google Maps.</p>
<pre class="r"><code>nba_table &lt;-
  html_nodes(x = html, xpath = table_xpath) %&gt;%  # scrape the HTML
  html_table(fill = TRUE, header = NA) %&gt;%  # parse as table
  as.data.frame() %&gt;%  # convert from list
  filter(Division == &quot;Northwest&quot;) %&gt;%  # NW division only
  separate(Coordinates, c(&quot;Coords1&quot;, &quot;Coords2&quot;, &quot;Coords3&quot;), &quot; / &quot;) %&gt;% 
  separate(Coords3, c(&quot;Latitude&quot;, &quot;Longitude&quot;), sep = &quot;; &quot;) %&gt;% 
  separate(Longitude, c(&quot;Longitude&quot;, &quot;X&quot;), sep = &quot; \\(&quot;) %&gt;% 
  mutate(
    Search = paste(Arena, City.State),  # combine location details
    Search = str_replace_all(Search, &quot;,&quot;, &quot;&quot;),  # replace comma with blank
    Search = str_replace_all(Search, &quot; &quot;, &quot;+&quot;),  # replace space with plus
    `Team code` = case_when(
      Team == &quot;Denver Nuggets&quot; ~ &quot;DEN&quot;,
      Team == &quot;Minnesota Timberwolves&quot; ~ &quot;MIN&quot;,
      Team == &quot;Oklahoma City Thunder&quot; ~ &quot;OKC&quot;,
      Team == &quot;Portland Trail Blazers&quot; ~ &quot;POR&quot;,
      Team == &quot;Utah Jazz&quot; ~ &quot;UTA&quot;
    )
  ) %&gt;% 
  select(
    Team, `Team code`, Arena, City = City.State, Latitude, Longitude, Search
  )

kable(nba_table)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Team</th>
<th align="left">Team code</th>
<th align="left">Arena</th>
<th align="left">City</th>
<th align="left">Latitude</th>
<th align="left">Longitude</th>
<th align="left">Search</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Denver Nuggets</td>
<td align="left">DEN</td>
<td align="left">Pepsi Center</td>
<td align="left">Denver, Colorado</td>
<td align="left">39.748611</td>
<td align="left">-105.0075﻿</td>
<td align="left">Pepsi+Center+Denver+Colorado</td>
</tr>
<tr class="even">
<td align="left">Minnesota Timberwolves</td>
<td align="left">MIN</td>
<td align="left">Target Center</td>
<td align="left">Minneapolis, Minnesota</td>
<td align="left">44.979444</td>
<td align="left">-93.276111﻿</td>
<td align="left">Target+Center+Minneapolis+Minnesota</td>
</tr>
<tr class="odd">
<td align="left">Oklahoma City Thunder</td>
<td align="left">OKC</td>
<td align="left">Chesapeake Energy Arena</td>
<td align="left">Oklahoma City, Oklahoma</td>
<td align="left">35.463333</td>
<td align="left">-97.515﻿</td>
<td align="left">Chesapeake+Energy+Arena+Oklahoma+City+Oklahoma</td>
</tr>
<tr class="even">
<td align="left">Portland Trail Blazers</td>
<td align="left">POR</td>
<td align="left">Moda Center</td>
<td align="left">Portland, Oregon</td>
<td align="left">45.531667</td>
<td align="left">-122.666667﻿</td>
<td align="left">Moda+Center+Portland+Oregon</td>
</tr>
<tr class="odd">
<td align="left">Utah Jazz</td>
<td align="left">UTA</td>
<td align="left">Vivint Smart Home Arena</td>
<td align="left">Salt Lake City, Utah</td>
<td align="left">40.768333</td>
<td align="left">-111.901111﻿</td>
<td align="left">Vivint+Smart+Home+Arena+Salt+Lake+City+Utah</td>
</tr>
</tbody>
</table>
<p>So now we have a simple table of teams, locations and a search string that we’ll pass to <code>gmapsdistance()</code>.</p>
</div>
<div id="calculate-distances" class="section level1">
<h1>Calculate distances</h1>
<p>The basic arguments to the <code>gmpasdistance()</code> function are the origin and destination (can be an address, postcode or latlong coordinates), the mode of travel (car, public transit, walking) and the return format (shape) of the data (each origin-destination pair per row, or a matrix). We want all possible combinations</p>
<p>We can make our key available in the package environment by using the <code>set.api.key()</code> function from the <code>gmapsdistance</code> package.</p>
<pre class="r"><code>library(gmapsdistance)
set.api.key(&quot;YOUR-API-KEY&quot;)</code></pre>
<p>Now we can query Google Maps with the API key. I’ve explained the function arguments in the code comments.</p>
<pre class="r"><code>nba_travel &lt;- 
  gmapsdistance(
    key = get.api.key(),  # retrieve the API key we set in the step above
    origin = nba_table$Search,  # vector of locations from our dataframe
    destination = nba_table$Search,  # as above
    combinations = &quot;all&quot;,  # all possible pairs of locations
    mode = &quot;driving&quot;,  # rather than walking, public transport or cycling
    shape = &quot;long&quot;  # one row per location-pair
  )</code></pre>
</div>
<div id="output" class="section level1">
<h1>Output</h1>
<p>What does the output look like?</p>
<pre class="r"><code>glimpse(nba_travel)</code></pre>
<pre><code>## List of 3
##  $ Time    :&#39;data.frame&#39;:    25 obs. of  3 variables:
##   ..$ or  : Factor w/ 5 levels &quot;Pepsi+Center+Denver+Colorado&quot;,..: 1 2 3 4 5 1 2 3 4 5 ...
##   ..$ de  : Factor w/ 5 levels &quot;Pepsi+Center+Denver+Colorado&quot;,..: 1 1 1 1 1 2 2 2 2 2 ...
##   ..$ Time: num [1:25] 0 47272 34477 65601 27969 ...
##  $ Distance:&#39;data.frame&#39;:    25 obs. of  3 variables:
##   ..$ or      : Factor w/ 5 levels &quot;Pepsi+Center+Denver+Colorado&quot;,..: 1 2 3 4 5 1 2 3 4 5 ...
##   ..$ de      : Factor w/ 5 levels &quot;Pepsi+Center+Denver+Colorado&quot;,..: 1 1 1 1 1 2 2 2 2 2 ...
##   ..$ Distance: num [1:25] 0 1471688 1091108 1997198 835730 ...
##  $ Status  :&#39;data.frame&#39;:    25 obs. of  3 variables:
##   ..$ or    : Factor w/ 5 levels &quot;Pepsi+Center+Denver+Colorado&quot;,..: 1 2 3 4 5 1 2 3 4 5 ...
##   ..$ de    : Factor w/ 5 levels &quot;Pepsi+Center+Denver+Colorado&quot;,..: 1 1 1 1 1 2 2 2 2 2 ...
##   ..$ status: chr [1:25] &quot;OK&quot; &quot;OK&quot; &quot;OK&quot; &quot;OK&quot; ...</code></pre>
<p>It’s a list object with three elements: <code>Time</code>, <code>Distance</code> and <code>Status</code>. Each list element is a dataframe with 25 observations (each team paired with every other) and 3 columns:</p>
<ul>
<li><code>or</code> – the origin point</li>
<li><code>de</code> – the destination point</li>
<li>one of <code>Time</code> in seconds, <code>Distance</code> in metres or <code>Status</code> (whether the request was successful)</li>
</ul>
<p>All our requests returned ‘OK’ for <code>Status</code> so there were no problems wth fetching the data.</p>
</div>
<div id="results-travel-distance" class="section level1">
<h1>Results: travel distance</h1>
<p>The data is returned in a tidy data frame with one row per origin-destination. We can clean this up by matching three-letter team codes to the data, arranging by distance within origin location and removing rows that provide the distance from each team to themselves (i.e. zero kilometres).</p>
<pre class="r"><code># Create a mini-lookup of search strings to three-letter team codes
nba_lookup &lt;- select(nba_table, `Team code`, Search)

# Make the output table easier to read by joining team codes
nba_distance &lt;- nba_travel$Distance %&gt;%
  left_join(nba_lookup, by = c(&quot;or&quot; = &quot;Search&quot;)) %&gt;% 
  left_join(
    nba_lookup, by = c(&quot;de&quot; = &quot;Search&quot;), suffix = c(&quot; (or)&quot;, &quot; (de)&quot;)
  ) %&gt;% 
  mutate(Distance = round(Distance/1000, 1)) %&gt;% # m to km
  select(`Team code (or)`, `Team code (de)`, Distance)

# View table
nba_distance %&gt;%
  arrange(`Team code (or)`, desc(Distance)) %&gt;% 
  filter(Distance != 0) %&gt;% 
  kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Team code (or)</th>
<th align="left">Team code (de)</th>
<th align="right">Distance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">DEN</td>
<td align="left">POR</td>
<td align="right">1996.7</td>
</tr>
<tr class="even">
<td align="left">DEN</td>
<td align="left">MIN</td>
<td align="right">1471.4</td>
</tr>
<tr class="odd">
<td align="left">DEN</td>
<td align="left">OKC</td>
<td align="right">1090.5</td>
</tr>
<tr class="even">
<td align="left">DEN</td>
<td align="left">UTA</td>
<td align="right">836.1</td>
</tr>
<tr class="odd">
<td align="left">MIN</td>
<td align="left">POR</td>
<td align="right">2781.2</td>
</tr>
<tr class="even">
<td align="left">MIN</td>
<td align="left">UTA</td>
<td align="right">1984.8</td>
</tr>
<tr class="odd">
<td align="left">MIN</td>
<td align="left">DEN</td>
<td align="right">1471.7</td>
</tr>
<tr class="even">
<td align="left">MIN</td>
<td align="left">OKC</td>
<td align="right">1270.4</td>
</tr>
<tr class="odd">
<td align="left">OKC</td>
<td align="left">POR</td>
<td align="right">3072.2</td>
</tr>
<tr class="even">
<td align="left">OKC</td>
<td align="left">UTA</td>
<td align="right">1911.6</td>
</tr>
<tr class="odd">
<td align="left">OKC</td>
<td align="left">MIN</td>
<td align="right">1266.9</td>
</tr>
<tr class="even">
<td align="left">OKC</td>
<td align="left">DEN</td>
<td align="right">1091.1</td>
</tr>
<tr class="odd">
<td align="left">POR</td>
<td align="left">OKC</td>
<td align="right">3072.9</td>
</tr>
<tr class="even">
<td align="left">POR</td>
<td align="left">MIN</td>
<td align="right">2782.0</td>
</tr>
<tr class="odd">
<td align="left">POR</td>
<td align="left">DEN</td>
<td align="right">1997.2</td>
</tr>
<tr class="even">
<td align="left">POR</td>
<td align="left">UTA</td>
<td align="right">1230.1</td>
</tr>
<tr class="odd">
<td align="left">UTA</td>
<td align="left">MIN</td>
<td align="right">2002.8</td>
</tr>
<tr class="even">
<td align="left">UTA</td>
<td align="left">OKC</td>
<td align="right">1911.4</td>
</tr>
<tr class="odd">
<td align="left">UTA</td>
<td align="left">POR</td>
<td align="right">1228.9</td>
</tr>
<tr class="even">
<td align="left">UTA</td>
<td align="left">DEN</td>
<td align="right">835.7</td>
</tr>
</tbody>
</table>
</div>
<div id="travel-distance-summaries" class="section level1">
<h1>Travel distance summaries</h1>
<p>It’s trivial to summarise the furthest travel distance within the Northwest for each team.</p>
<pre class="r"><code>nba_distance %&gt;% 
  arrange(`Team code (or)`, desc(Distance)) %&gt;%
  group_by(`Team code (or)`) %&gt;% 
  slice(1) %&gt;% 
  ungroup() %&gt;% 
  arrange(desc(Distance)) %&gt;% 
  kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Team code (or)</th>
<th align="left">Team code (de)</th>
<th align="right">Distance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">POR</td>
<td align="left">OKC</td>
<td align="right">3072.9</td>
</tr>
<tr class="even">
<td align="left">OKC</td>
<td align="left">POR</td>
<td align="right">3072.2</td>
</tr>
<tr class="odd">
<td align="left">MIN</td>
<td align="left">POR</td>
<td align="right">2781.2</td>
</tr>
<tr class="even">
<td align="left">UTA</td>
<td align="left">MIN</td>
<td align="right">2002.8</td>
</tr>
<tr class="odd">
<td align="left">DEN</td>
<td align="left">POR</td>
<td align="right">1996.7</td>
</tr>
</tbody>
</table>
<p>Similarly, we can get the total distance each team must travel to each of the others in the Northwest Division.</p>
<pre class="r"><code>nba_distance %&gt;% 
  group_by(`Team code (or)`) %&gt;% 
  summarise(`Total distance` = sum(Distance)) %&gt;% 
  arrange(desc(`Total distance`)) %&gt;% 
  kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Team code (or)</th>
<th align="right">Total distance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">POR</td>
<td align="right">9082.2</td>
</tr>
<tr class="even">
<td align="left">MIN</td>
<td align="right">7508.1</td>
</tr>
<tr class="odd">
<td align="left">OKC</td>
<td align="right">7341.8</td>
</tr>
<tr class="even">
<td align="left">UTA</td>
<td align="right">5978.8</td>
</tr>
<tr class="odd">
<td align="left">DEN</td>
<td align="right">5394.7</td>
</tr>
</tbody>
</table>
<div id="travel-distance-lookup" class="section level2">
<h2>Travel distance lookup</h2>
<p>Another way to view this is to ‘spread’ the data from long to wide format to create a look-up between origin teams (rows) and destination teams (columns).</p>
<pre class="r"><code># Create easy look-up table for travel distances between teams
nba_distance %&gt;% 
  spread(key = `Team code (de)`, value = Distance) %&gt;% 
  rename(Team = `Team code (or)`) %&gt;% 
  kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Team</th>
<th align="right">DEN</th>
<th align="right">MIN</th>
<th align="right">OKC</th>
<th align="right">POR</th>
<th align="right">UTA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">DEN</td>
<td align="right">0.0</td>
<td align="right">1471.4</td>
<td align="right">1090.5</td>
<td align="right">1996.7</td>
<td align="right">836.1</td>
</tr>
<tr class="even">
<td align="left">MIN</td>
<td align="right">1471.7</td>
<td align="right">0.0</td>
<td align="right">1270.4</td>
<td align="right">2781.2</td>
<td align="right">1984.8</td>
</tr>
<tr class="odd">
<td align="left">OKC</td>
<td align="right">1091.1</td>
<td align="right">1266.9</td>
<td align="right">0.0</td>
<td align="right">3072.2</td>
<td align="right">1911.6</td>
</tr>
<tr class="even">
<td align="left">POR</td>
<td align="right">1997.2</td>
<td align="right">2782.0</td>
<td align="right">3072.9</td>
<td align="right">0.0</td>
<td align="right">1230.1</td>
</tr>
<tr class="odd">
<td align="left">UTA</td>
<td align="right">835.7</td>
<td align="right">2002.8</td>
<td align="right">1911.4</td>
<td align="right">1228.9</td>
<td align="right">0.0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="results-travel-time" class="section level1">
<h1>Results: travel time</h1>
<p>You can do all of the above for travel time as well. I’m going to provide the simple lookup table for thr sake of brevity.</p>
<pre class="r"><code># Package for tidy time handling
library(lubridate)</code></pre>
<pre><code>## 
## Attaching package: &#39;lubridate&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:base&#39;:
## 
##     date</code></pre>
<pre class="r"><code># Create easy look-up table for travel time between teams
nba_travel$Time %&gt;%
  left_join(nba_lookup, by = c(&quot;or&quot; = &quot;Search&quot;)) %&gt;% 
  left_join(
    nba_lookup, by = c(&quot;de&quot; = &quot;Search&quot;), suffix = c(&quot; (or)&quot;, &quot; (de)&quot;)
  ) %&gt;% 
  mutate(Time = round(Time/60/60, 1)) %&gt;% 
  select(`Team code (or)`, `Team code (de)`, Time) %&gt;% 
  spread(key = `Team code (de)`, value = Time) %&gt;% 
  kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Team code (or)</th>
<th align="right">DEN</th>
<th align="right">MIN</th>
<th align="right">OKC</th>
<th align="right">POR</th>
<th align="right">UTA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">DEN</td>
<td align="right">0.0</td>
<td align="right">13.1</td>
<td align="right">9.5</td>
<td align="right">18.2</td>
<td align="right">7.8</td>
</tr>
<tr class="even">
<td align="left">MIN</td>
<td align="right">13.1</td>
<td align="right">0.0</td>
<td align="right">11.5</td>
<td align="right">25.2</td>
<td align="right">18.4</td>
</tr>
<tr class="odd">
<td align="left">OKC</td>
<td align="right">9.6</td>
<td align="right">11.5</td>
<td align="right">0.0</td>
<td align="right">27.5</td>
<td align="right">17.1</td>
</tr>
<tr class="even">
<td align="left">POR</td>
<td align="right">18.2</td>
<td align="right">25.3</td>
<td align="right">27.5</td>
<td align="right">0.0</td>
<td align="right">11.2</td>
</tr>
<tr class="odd">
<td align="left">UTA</td>
<td align="right">7.8</td>
<td align="right">18.3</td>
<td align="right">17.0</td>
<td align="right">11.2</td>
<td align="right">0.0</td>
</tr>
</tbody>
</table>
</div>
