---
title: Fix leaky pipes in R
author: Matt Dray
date: '2019-04-07'
categories:
  - code
  - tutorial
tags:
  - debug
  - magrittr
  - pipe
  - pipes
  - pipecleaner
  - r
  - tamper
  - tidylog
  - tidyverse
  - ViewPipeSteps
slug: fix-leaky-pipes
draft: no
---

```{r setup}
library(palmerpenguins)
library(dplyr, warn.conflicts = FALSE)
```

<div class="figure">
<img src="https://media.giphy.com/media/Y8qTuvMUjSh7a/giphy.gif" alt="The character Data from Star Trek: The Next Generation is smoking a pipe.">
<p class="caption">Data leaking from a pipe ([via Giphy](https://giphy.com/gifs/tony-bennett-Y8qTuvMUjSh7a))</p>
</div>

<div class="tip"> `r fontawesome::fa("exclamation-circle")` <b>Note</b>

This post has been updated to include newer
</div>

# tl;dr

Chaining R function calls with the {magrittr} pipe operator (`%>%`) makes data wrangling more intuitive for many users, but it can be difficult to confirm what is happening at each step. This post explores some options to help prevent errors.

<div class="tip"> `r fontawesome::fa("exclamation-circle")` <b>Note</b>

I came back to this post in late 2021 to replace the dataset[^iris] with {palmerpenguins}, to improve the text and to add {boomer}. Note also that base R's pipe (`|>`) was introduced after this post was written and is not included here.
</div>

# C'est un pipe

R's [`%>%` (pipe) operator](https://magrittr.tidyverse.org/articles/magrittr.html) ets you chain function calls. It was created for [Stefan Milton Bache](http://stefanbache.dk/) and [Hadley Wickham](http://hadley.nz/)'s [{magrittr} package](https://CRAN.R-project.org/package=magrittr) and popularised by [the tidyverse](https://www.tidyverse.org/).

Here's an illustrative example using the `penguins` data from the {palmerpenguins} package. The {magrittr} pipe is loaded when {dplyr} is attached.

```{r pipeline-example, warning=FALSE, message=FALSE}
library(palmerpenguins)
library(dplyr, warn.conflicts = FALSE)

penguin_pipe <- penguins %>%
  filter(species %in% c("Gentoo", "Chinstrap")) %>% 
  group_by(species) %>% 
  summarise(`mean_mass_g` = mean(body_mass_g, na.rm = TRUE)) %>% 
  mutate(`mean_mass_g` = round(`mean_mass_g`, 1))

penguin_pipe
```

So, we take the `penguins` data, then filter for two particular pecies, then group by those species, then summarise by taking the mean of a variable and then finally we mutate that variable by rounding it. 

# Ce n'est pas debuggable?

[Some are critical of the pipe approach](https://twitter.com/TedPetrou/status/1109519764613787648?ref_src=twsrc%5Etfw). Long pipes obscure what's happened to your data and make debugging hard. There's [no clear recommendation for solving this](https://community.rstudio.com/t/whats-currently-the-recommended-way-to-debug-pipe-chains/14724) either. 

I think most people 'build pipelines' interactively and check their outputs at each step. You could also make smaller, more sensibly-sized pipes for each 'unit' of wrangling (read, clean, model, etc) rather than one massive one. Hadley Wickham discusses this in [the pipes chapter of the R for Data Science book](https://r4ds.had.co.nz/pipes.html). 

This post summarises some solutions.

The table below summarises it even more. 'Message' means whether it prints something informative to the console; `View()` and `print()` tell you if the data set can be viewed at each step; and 'debug' if it opens the debug menu.


| Package         | Description                                         | Message  | `View()` | `print()` | Debug    |
| :---------------| :-------------------------------------------------- | :------: | :------: | :-------: | :------: |
| {tidylog}       | Console-printed description of changes              | &#10004; | &#10008; | &#10008;  | &#10008; |
| {ViewPipeSteps} | RStudio addin: see changes to data set per step      | &#10008; | &#10004; | &#10004;  | &#10008; |
| {tamper}        | Stack trace replacement for pipe debugging          | &#10004; | &#10008; | &#10008;  | &#10004; |
| {pipecleaner}   | RStudio addin: 'burst' pipes and debug              | &#10008; | &#10008; | &#10008;  | &#10004; |
| {magrittr}      | `debug_pipe()` function                             | &#10008; | &#10008; | &#10008;  | &#10004; |
| `debug()`       | R's good old `debug()` function                     | &#10008; | &#10008; | &#10008;  | &#10004; |
| {pipes}         | Special assignment operators                        | &#10008; | &#10004; | &#10004;  | &#10004; |
| Bizarro pipe    | Replace `%>%` with `->.;` and observe `.Last.value` | &#10008; | &#10008; | &#10008;  | &#10008; |

Read on for explanations and examples.

# Ce n'est pas une probleme?

I've gathered some solutions into three categories (click to jump):

1. [Summary inspection](#summary-inspection)
    a. [{tidylog}](#tidylog)
    b. [{ViewPipeSteps}](#viewpipesteps)
1. [Debug mode](#debug-mode)
    a. [{tamper}](#tamper)
    b. [{pipecleaner}](#pipecleaner)
    c. [{magrittr}](#magrittr)
    d. [`debug()`](#debug-fun)
1. [Operator hacking](#operator-hacking)
    a. [{pipes}](#pipes)
    b. [Bizarro pipe](#bizarro-pipe)

## 1. Summary inspection {#summary-inspection}

These are packages for seeing what happened to your data set at each step of your pipeline, rather than highlighting where the problem was.

### 1a. {tidylog} {#tidylog}

[The {tidylog} package](https://github.com/elbersb/tidylog) was written by [Benjamin Elbers](https://elbersb.de/public/). It prints to the console some summary sentences of the changes that have happened to your data after each {dplyr} step.

{tidylog} will mask the functions of {dplyr}, which we've already attached. Basically, you can continue to use the names of {dplyr} function names, but you'll actually be calling the {tidylog} versions.

```{r tidylog-mask}
# install.packages("tidylog")  # on CRAN
library(tidylog)
```

You can see from the output that {tidylog} masks all the {dplyr} functions. Now we'll get the {tidylog} side-effect of each function call, which reports to the console the changes to the data at each step in the pipeline.

```{r tidylog-example2}
penguin_pipe <- penguins %>%
  filter(species %in% c("Gentoo", "Chinstrap")) %>% 
  group_by(species) %>% 
  summarise(`mean_mass_g` = mean(body_mass_g, na.rm = TRUE)) %>% 
  mutate(`mean_mass_g` = round(`mean_mass_g`, 1))
```

This a nice passive approach. But how does this help? We can sense-check each step. For example:

```{r tidylog-example}
penguin_pipe <- penguins %>%
  filter(species == "Pingu") %>% 
  group_by(species) %>% 
  summarise(`mean_mass_g` = mean(body_mass_g, na.rm = TRUE)) %>% 
  mutate(`mean_mass_g` = round(`mean_mass_g`, 1))
```

Did you spot the contrived error? I filtered for species that don't exist in the data set. This was reported clearly as `filter: removed all rows (100%)` in the console. A nice quick check without being too invasive.

I'll unload {tidylog} before continuing so it doesn't interfere with the other examples.

```{r tidylog-unload}
unloadNamespace("tidylog")
```

### 1b. {ViewPipeSteps} {#viewpipesteps}

[The {ViewPipeSteps} package](https://github.com/daranzolin/ViewPipeSteps) is an RStudio add-in created by [David Ranzolin](https://daranzolin.github.io/). Basically it runs `View()` or `print()` for each of the steps in your pipeline so you can see what's happened to the the data set.

```{r viewpipesteps, eval=FALSE}
# remotes::install_github("daranzolin/ViewPipeSteps")  # not on CRAN
library(ViewPipeSteps)
```

After you install it and restart RStudio, you can highlight your code and select 'View Pipe Chain Steps' (i.e. send intermediate results to to separate tabs in the script pane) or 'Print Pipe Chain Steps' (i.e. send intermediate results to the console) from the add-ins menu.

<insert gif>

Beware if you have lots of steps in your pipeline because it's going to open many script tabs or fill up your console.

This is good for smaller datasets, especially if you're very familiar with their content. It may be a little overwhelming relative to {tidylog}'s succinct statements, but you get to see the data itself at each step of the pipeline. 

## 2. Debug mode {#debug-mode}

The packages in this section help to highlight where a problem occurred. These take you to [RStudio's debug menu](https://support.rstudio.com/hc/en-us/articles/205612627-Debugging-with-RStudio), which is worth reading up on if you haven't used it before.

### 2a. {tamper} {#tamper}

[Gábor Csárdi](http://gaborcsardi.org/)'s [{tamper} package](https://github.com/gaborcsardi/tamper) makes pipe debugging easier with a simple, informative interface. The package is currently available but is archived.

You set the error argument of the options to `tamper` once installed and loaded. From now on {tamper} will override the default stack trace report you get when an error is found.

When there's an error, {tamper} highlights the problematic line with an arrow. Typing '0' will exit the {tamper} report; '1' switches you back to the stack trace; '2' will enter debug mode. 

This is friendly for beginners especially, since the {tamper} output is more readable.

```{r tamper, eval=FALSE}
# remotes::install_github("gaborcsardi/tamper")  # not on CRAN
library(tamper)

options(error = tamper::tamper)  # set error option to tamper

penguins %>%
  filter(species %in% c("Gentoo", "Chinstrap")) %>% 
  group_by(species) %>% 
  summarise(`mean_mass_g` = mean(body_mass_lb, na.rm = TRUE)) %>% 
  mutate(`mean_mass_g` = round(`mean_mass_g`, 1))
```

You'll get this output:

```
## Error in mean(body_mass_lb : object 'body_mass_lb' not found
## 
## Enter 0 to exit or choose:
## 
## 1:    Switch mode
## 2:    Take me to the error
## 
## 3:    penguins %>%
## 4:      filter(., species %in% c("Gentoo", "Chinstrap")) %>%
## 5:      group_by(., species) %>%
## 6: ->   summarise(., `mean_mass_g` = mean(body_mass_lb, na.rm = TRUE)) %>%
## 7:      mutate(., `mean_mass_g` = round(`mean_mass_g`, 1))
## 
## Selection:
```

You can see the arrow (`->`) pointing to the problematic line. The last line is a prompt for you to type your selection into the console and press <kbd>Enter</kbd>.

### 2b. {pipecleaner} {#pipecleaner}

[The {pipecleaner} package](https://alistaire47.github.io/pipecleaner/index.html) is an RStudio addin by [Edward Visel](https://alistaire.rbind.io/). It has the best name.

```{r burst-pipe, eval=FALSE}
# remotes::install_github("alistaire47/pipecleaner")  # not on CRAN
library(pipecleaner)
```

You highlight your code and select 'debug pipeline in browser' from the RStudio addins menu. This 'bursts' your pipeline to one intermediate object per function call and opens the debug menu. You can also simply 'burst pipes' from the addins menu without debug mode.

Here's the intact, original pipeline:

```{r pipeclean-before, eval=FALSE}
penguins_pipe <- penguins %>%
  filter(species %in% c("Gentoo", "Chinstrap")) %>% 
  group_by(species) %>% 
  summarise(`mean_mass_g` = mean(body_mass_g, na.rm = TRUE)) %>% 
  mutate(`mean_mass_g` = round(`mean_mass_g`, 1))
```

Here's what the 'burst pipes' look like:

```{r pipeclean-after, eval=FALSE}
dot1 <- filter(penguins, species %in% c("Gentoo", "Chinstrap"))
dot2 <- group_by(dot1, species)
dot3 <- summarise(dot2, mean_mass_g = mean(body_mass_g, na.rm = TRUE))
penguins_pipe <- mutate(dot3, mean_mass_g = round(mean_mass_g,1))
```

The names for the intermediate objects default to `dot1` etc. Fortunately, the {pipecleaner} addin also lets you 'burst pipes and set names', which opens a Shiny app for you to name the objects as you please.

<div class="figure">
<img src="/post/2019-04-01-fix-leaky-dplyr-pipes_files/burst-pipes.png" alt="Screenshot of an R Shiny app to rename objects in a 'burst' magrittr pipeline. On the right is a magrittr pipeline that's been broken into one object per function, where the names are dot1, dot2, etc. on the left, are text boxes that let you rename the objects as you please." width="100%"/>
</div>

Note also that there's no 'fix pipes' option to return to your original pipeline.

### 2c. {magrittr} {#magrittr}

Surprise: [the {magrittr} package](https://magrittr.tidyverse.org/reference/debug_pipe.html) itself has the function `debug_pipe()` to let you see what's being passed into the next function.

```{r magrittr-example, eval=FALSE}
library(magrittr)

penguins %>%
  filter(species %in% c("Gentoo", "Chinstrap")) %>% 
  group_by(species) %>% 
  summarise(`mean_mass_g` = mean(body_mass_lb, na.rm = TRUE)) %>% 
  debug_pipe() %>% 
  mutate(`mean_mass_g` = round(`mean_mass_g`, 1))
```

Worth mentioning because `%>%` gets re-exported with other packages, especially {tidyverse} packages, but `debug_pipe()` doesn't. That means you must explicitly attach {magrittr} to use it.

### 2d. `debug()` {#debug-fun}

You can simply use R's `debug()` function, as [pointed out by Nathan Werth](https://community.rstudio.com/t/whats-currently-the-recommended-way-to-debug-pipe-chains/14724/3?u=matt).

You can do this for a given function in the pipeline:

```{r debug-base, eval=FALSE}
debug(summarise)

penguins_pipe<- penguins %>%
  filter(species %in% c("Gentoo", "Chinstrap")) %>% 
  group_by(species) %>% 
  summarise(`mean_mass_g` = mean(body_mass_g, na.rm = TRUE)) %>% 
  mutate(`mean_mass_g` = round(`mean_mass_g`, 1))
  
undebug(summarise)
```

Or you can even debug each step by setting up ```debug(`%>%`)```, since the pipe is itself a function, after all.

## 3. Operator hacking

It's possible to make variant pipe operators. Maybe we don't even need `%>%`?

### 3a. {pipes} {#pipes}

[Antoine Fabri](https://github.com/moodymudskipper) forked the {magrittr} GitHub repo to add a bunch of `%>%` variants that have side properties. These are available from his [{pipes} package](https://github.com/moodymudskipper/pipes).

A few of direct relevance to this discussion:

* `%P>%` to `print()` the data set to the console
* `%V>%` will `View()` the full data set
* `%D>%` opens with debug menu

Others apply different functions during the piping step. There's some nice ones for summaries, like `%glimpse>%` and `%skim>%`.

Here's an example of `%P>%` that pipes forward into the next function and prints it to console. (The final output isn't printed because I've assigned it to `iris_pipes()`, of course.)

```{r pipes-example}
# remotes::install_github("moodymudskipper/pipes")  # not on CRAN
library(pipes)

iris_pipes <- iris %>%
  filter(Species %in% c("setosa", "versicolor")) %>% 
  group_by(Species) %P>% 
  summarise(`Mean width` = mean(Sepal.Width)) %>%
  mutate(`Mean width` = round(`Mean width`, 1))
```

So this one could have gone in the 'summary inspection' section above, but it contains more functions than for printing and viewing alone.

### 3b. Bizarro pipe {#bizarro-pipe}

Forget dependencies. We can create an operator with base R that acts like a pipe but can be run so that we can check what's happening at each step.

[John Mount](http://www.win-vector.com/site/staff/john-mount/)'s solution is [the 'Bizarro pipe'](http://www.win-vector.com/blog/2017/01/using-the-bizarro-pipe-to-debug-magrittr-pipelines-in-r/), which looks like `->.;`. 

The `->.;` operator reads as 'right-assign the left-hand side to a period and then perform the next operation'.

Things you might be wondering:

* yes, you can use a `->` for assignment to the right
* yes, you can assign to a `.`, but you'll need to explicitly supply it as the data argument to the next function call in your Bizarro pipeline
* yes, you can use semi-colons in R for run-on code execution -- try `head(penguins); tail(penguins)`

So what? Well, you can execute each line in turn and check the output. But wait: an object called `.` is not presented in the global environment. Not unless you check 'Show .Last.value in environment listing' in RStudio's settings. Now when you run the line you'll see the '.Last.value' that's been output.

```{r bizarro-example}
penguins_pipe <- penguins %>%
  filter(., species %in% c("Gentoo", "Chinstrap")) ->.;
  group_by(., species) ->.;
  summarise(., `mean_mass_g` = mean(body_mass_lb, na.rm = TRUE)) ->.;
  mutate(., `mean_mass_g` = round(`mean_mass_g`, 1))
```

So it's slightly convoluted and people looking at your code are going to be confused, but hey, no dependencies are needed.

# M'aider

What's your approach to this problem? 

What have I missed?

<div class="figure">
<img src="https://media.giphy.com/media/TBddd797slSxO/giphy.gif" alt="A distinguished-looking cat with top hat, monocle and pipe walks through some grass."/>
<p class="caption">Bonus cat-with-pipe gif ([via Giphy](https://giphy.com/gifs/cat-funny-mash-up-TBddd797slSxO))</p>
</div>

---

<details><summary>Click for session info</summary>
```{r details, echo=FALSE}
xfun::session_info()
```
</details>

[^iris]: It was `iris`. [Read more about it](https://www.garrickadenbuie.com/blog/lets-move-on-from-iris/).