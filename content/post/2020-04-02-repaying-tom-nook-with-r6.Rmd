---
title: Repaying Tom Nook with R6
author: Matt Dray
date: '2020-04-02'
slug: repaying-tom-nook-with-r6
categories:
  - code
  - tutorial
tags:
  - r
  - r6
  - animal-crossing
draft: yes
---

## tl;dr

How would raccoon-dog capitalist Tom Nook accept home-loan payments if your Animal Crossing island only had access to R?

I built a version of Animal Crossing's Automatic Bell Dispenser (an ATM) using the R6 class from Winston Chang's [{R6} package](https://r6.r-lib.org/). It lets you build classes of objects that can be modified in place (i.e. updated without overwriting), which is handy for the idea of a bank account. This is an extension of a question from Hadley Wickham's [Advanced R](https://adv-r.hadley.nz/r6.html) book.

# I don't understand any of those words

## Animal Crossing

Animal Crossing is a Nintendo video-game franchise in which you, a human, arrive on an island and befriend its anthropomorphic animal villagers. It's pretty whlesome and incredibly chill. You catch insects and fish, design clothes, fill a museum with fossils, develop the infrastructure of the island and interact with other players.

The latest version, New Horizons for the Nintendo Switch, was released at the perfect time for people seeking a getaway from government-enforced self-isolation. Where better?

You know it's popular because the memes are strong.

## Tom Nook

Sounds stress-free right? Well, apart from catching the thousandth sea bass[^seabass] in a row while trying to collect a rare stringfish before the end of March, there's few troubles.

There is, however, the looming spectre of a home loan given to you by Tom Nook.

Tom Nook is a tanooki. Depending on who you ask, he's either a maniacal [rip-off merchant](https://www.vice.com/en_us/article/n7jyjd/tom-nook-ripping-you-off-animal-crossing-new-horizons-bells-to-usd), or a misunderstood chap who is, after all, offering you an interest-free loan with no collection plan.

But you should pay him back, right? And if you do, he'll upgrade your place again with another interest-free loan. 

## Automatic Bell Dispenser

How do you pay off your home loan? The island's currency is Bells, which can be gained by selling fish or furniture, digging it from the ground, or doing tasks for other residents. You use an Automatic Bell Dispenser (ABD, think ATM) housed in resident services on the island to save and withdraw your cash, as well as pay your loan.

## R6

R is a really function-focused language. Pretty much everything involves writing a function to output an object.

But there are other ways to do things. One is with object-oriented programmong (OOP), which are more common in other languages. here, you create an object that has a collection of values (fields) and functions (methods) that are defined by the class of the object. A class should be defined for some small unit of functionality.

Crucially, the methods you call can modify fields 'in place'. This means you don't have to use assignment to overwite your object with a modified version, like `data <- data[, c("col_a", "col_b")]`. Instead, something like `object$some_method()` will directly alter the class's properties without assignment.

A really intriguing and illustrative example is how Giora Simonchi's Castle of R, a text adventure game buit using {R6}. Here, classes are things like 'room' and 'door' that have varous properties and actions you can take on them. The properties and actions change as you progress, given factors like you rlocation and items you may be carrying.

# Demo

I'll show how the thing works first and then talk through the code.

There's quite a lot of code to show. You can click to expand the entire code here, but I'll step through each block to explain it's purpose.

```{r library}
# install.packages(R6) to get the package from CRAN
library(R6)
```

<details><summary>Click for the full code defining the Automatic Bell Dispenser class</summary>
```{r abd}
AutomaticBellDispenser <- R6Class(
  "AutomaticBellDispenser",
  list(
    
    # set initial values
    savings = 0,
    loan = 2498000,  # final loan size
    
    # Startup message shows account status and options
    initialize = function(...) {
      loan_formatted <- format(self$loan, big.mark = ",", scientific = FALSE)
      savings_formatted <- format(  # separate with commas, prevent sci notation
        self$savings, big.mark = ",", scientific = FALSE
      )
      cat("Automatic Bell Dispenser (ABD)\n\n")  # cat() prints to console
      cat(emo::ji("bell"), "Loan Balance:", loan_formatted, "Bells\n")
      cat(emo::ji("pig2"), "Savings Balance:", savings_formatted, "Bells\n\n")
      cat(
        "Please make a selection from the menu below\n\n",
        emo::ji("house"), "loan_payment()\n",
        emo::ji("arrow_up"), "deposit()\n",
        emo::ji("arrow_down"), "withdrawal()"
      )
    },
    
    # function to deposit an amount into savings
    deposit = function(amount = 0) { 
      amount_int <- as.integer(amount)  # round to nearest lowest integer
      if (amount - amount_int > 0) {  # warning if rounding has occurred
        warning(
          "Deposit rounded to ", amount_int, " Bells.",
          call. = FALSE # prevents printing of the error-causing line
        )
      } else {
        self$savings <- self$savings + amount_int  # add amount to savings
      }
      invisible(self)
    },
    
    # function to withdraw an amount from savings
    withdrawal = function(amount = 0) {
      amount_int <- as.integer(amount)  # round to nearest lowest integer
      if (amount - amount_int > 0) {  # warning if rounding has occurred
        warning("Withdrawal rounded to ", amount_int, " Bells.", call. = FALSE)
      }
      if (self$savings - amount_int < 0) {
        warning(  # can't withdraw more than you have so warn and take max
          "Withdrew all savings: ", self$savings, " Bells.", call. = FALSE
        )
        self$savings <- 0
      } else {  # otherwise subtract amount from your savings
        self$savings <- self$savings - amount_int
        invisible(self)
      }
    },
    
    # function to make loan payment from savings
    loan_payment = function(amount = 0, full_amount = FALSE) {
      if (self$loan == 0) {  # stop if the loan has already been paid in full
        stop("You already finished paying your loan!", call. = FALSE)
      }
      amount_int <- as.integer(amount)  # round to nearest lowest integer
      if (amount - amount_int > 0) {  # warning if rounding has occurred
        warning("Payment rounded to ", amount_int, " Bells.", call. = FALSE)
      }
      if (full_amount == TRUE) {  # choose to pay with everything in savings
        self$loan <- self$loan - self$savings  # reduce loan by savings amount
        self$savings <- 0  # remove all savings
      } else if (self$savings - amount_int < 0) {
        warning(  # can't pay more than total savings, so warn and pay max
          "Paid total amount from savings instead: ", self$savings, " Bells.",
          call. = FALSE
        )
        self$loan <- self$loan - self$savings  # subtract total savings
        self$savings <- 0  # all savings used for this repayment
      } else if (self$loan - amount_int < 0) {
        warning(  # can't pay more than remaining loan, warn and pay remaining
          "Paid total remaining loan instead: ", self$loan, " Bells.",
          call. = FALSE
        )
        self$loan <- 0  # loan paid in full
        self$savings <- amount_int - self$loan  # excess back into savings
      } else {  # otherwise just remove the amount from the savings and loan
        self$savings <- self$savings - amount_int
        self$loan <- self$loan - amount_int
      }
      if (self$loan == 0) {  # when the loan is totally cleared
        cat(
          emo::ji("smiley"),
          "Sweet! I finally finished paying off my very last home loan!",
          emo::ji("tada")
        )
      }
      invisible(self)
    },
    
    # Print method matches initialisation message
    print = function(...) {
      loan_formatted <- format(self$loan, big.mark = ",", scientific = FALSE)
      savings_formatted <- format(
        self$savings, big.mark = ",", scientific = FALSE
      )
      cat("Automatic Bell Dispenser (ABD)\n\n")
      cat(emo::ji("bell"), "Loan Balance:", loan_formatted, "Bells\n")
      cat(emo::ji("pig2"), "Savings Balance:", savings_formatted, "Bells\n\n")
      cat(
        "Please make a selection from the menu below\n\n",
        emo::ji("house"), "loan_payment()\n",
        emo::ji("arrow_up"), "deposit()\n",
        emo::ji("arrow_down"), "withdrawal()"
      )
    }
      
  )
)
```
</details>

## Initialise

Having defined the class, we have to initiliase a new instance. I"m going to call the object `account` because that sees pretty sensible.

```{r initialise}
account <- AutomaticBellDispenser$new()
```

Initialising the class triggers the printing of the current details and instuctions. This is what you see on the Automatic Bell Dispenser in the game when you start it up.

## Make a deposit

Now we can make a deposit to our account. Use `$` notation to say 'to the `account` object apply the `deposit` method'. In this case, the value supplied to `deposit` is the amount of Bells. You can check the status of the account by typing its name.

```{r deposit}
account$deposit(1000)
account
```

Or, we can access the `savings` field directly from the `account` object:

```{r savings}
account$savings
```

So we now have savings of 1000 Bells!

## Withdraw and pay loan

We can also withdraw and make loan payments. You can chain these calls together.

```{r withdraw-loan}
account$withdrawal(200)$loan_payment(300)
account
```

See how our savings went down to 500 Bells because we both withdrew money (200 Bells) and made a loan payment (300 Bells)?

[^seabass]: _No. Wait. It's at least a C+. No. Wait. It's at least a C+. No. Wait._