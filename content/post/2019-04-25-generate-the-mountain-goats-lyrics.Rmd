---
title: Generate The Mountain Goats lyrics
author: Matt Dray
date: '2019-04-25'
slug: gen-tmg-lyrics
categories:
  - R
  - pop culture
tags:
  - dplyr
  - spotifyr
  - markovifyR
  - markovify
---

The Mountain Goats have released their seventeenth studio album, _In League with Dragons_.

John Darnielle has written a lot of words in these seventeen albums, nevermind the various other EPs and releases he's been involved with.

What does a typical line from The Mountain Goats look like?


# {spotifyr}

The {spotifyr} package pulls artist and album information from Spotify, along with some interesting 'audio features' like danceability. It also fetches lyrics from Genius via the {genius} package. 

We need an access token to use the Spotify API. Sign up for a developer account and store your client ID and secret as `SPOTIFY_CLIENT_ID=X` and `SPOTIFY_CLIENT_SECRET=Y` in your .Renviron file, which you can open with `usethis::edit_r_environ()`. We can read this using the `get_spotify_access_token()` function.

```{r}
# install.packages("spotifyr")  # if you haven't already
library(spotifyr)
access_token <- get_spotify_access_token()
```

# Get discography

The `get_discography()` function fetches a named artis's back-catalogue, including the lyrics. 

```{r}
# goat_discography <- readRDS("~/Desktop/goat_discography.RDS")
goat_discography <- spotifyr::get_discography("the mountain goats")
glimpse(goat_discography)
```

Simplify the data frame so it's easier to handle.

```{r}
goat_disco <- goat_discography %>% 
  ungroup() %>% 
  select(
    album_name, album_release_year,  # album
    track_name, track_number, duration_ms,  # track info
    key_name, mode_name, key_mode, tempo, time_signature,  # music info
    danceability, energy, loudness, mode, speechiness,  # audio features
    acousticness, instrumentalness, liveness, valence,  # audio features
    lyrics
  )
```

And then we can get hold of just the lines.

```{r}
goat_lyrics <- goat_disco %>%
  filter(lyrics != "NULL")  # some lyrics weren't collected
  select(lyrics) %>%  # this is a list-column
  unnest(lyrics) %>%   # unpack the list-column
  pull(lyric)  # convert column to vector
```

# {markovifyr}

```{r}
# system("pip install markovify")
library(markovifyR)
library(furrr)

markov_model <- generate_markovify_model(
    input_text = goat_lyrics,
    markov_state_size = 2L,
    max_overlap_total = 25,
    max_overlap_ratio = .85
  )
```

Now generate some lines.

```{r}
markovify_text(
  markov_model = markov_model,
  maximum_sentence_length = NULL,
  output_column_name = 'goat_speak',
  count = 25,
  tries = 100,
  only_distinct = TRUE,
  return_message = TRUE
)
```

You can provide words that will start the generated lines.

```{r}
markovify_text(
  markov_model = markov_model,
  maximum_sentence_length = NULL,
  start_words = c("If", "You", "I"),
  output_column_name = 'goat_speak',
  count = 25,
  tries = 100,
  only_distinct = TRUE,
  return_message = TRUE
)
```